<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tạo khuyến mãi mới</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="mb-4">Tạo khuyến mãi mới</h2>
        
        <div th:if="${error}" class="alert alert-danger" role="alert">
            <span th:text="${error}"></span>
        </div>
        
        <form th:action="@{/seller/promotions}" method="post" th:object="${promotion}">
            <div class="form-section">
                <h4>Thông tin chung</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Mã khuyến mãi *</label>
                        <input type="text" class="form-control" th:field="*{code}" required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('code')}" 
                             th:errors="*{code}"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tên chương trình *</label>
                        <input type="text" class="form-control" th:field="*{name}" required>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Mô tả</label>
                    <textarea class="form-control" th:field="*{description}" rows="3"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Loại khuyến mãi *</label>
                        <select class="form-select" th:field="*{type}" required>
                            <option value="">Chọn loại khuyến mãi</option>
                            <option value="PERCENTAGE">Giảm giá theo %</option>
                            <option value="FIXED">Giảm giá cố định (VNĐ)</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Giá trị *</label>
                        <div class="input-group">
                            <input type="number" class="form-control" th:field="*{value}" step="0.01" min="0" required>
                            <span class="input-group-text" th:if="${promotion != null && promotion.type == 'PERCENTAGE'}">%</span>
                            <span class="input-group-text" th:if="${promotion == null || promotion.type != 'PERCENTAGE'}">₫</span>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Giá trị đơn hàng tối thiểu</label>
                        <div class="input-group">
                            <input type="number" class="form-control" th:field="*{minOrderValue}" min="0">
                            <span class="input-group-text">₫</span>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ngày bắt đầu *</label>
                        <input type="datetime-local" class="form-control" th:field="*{startDate}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ngày kết thúc *</label>
                        <input type="datetime-local" class="form-control" th:field="*{endDate}" required>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Số lần sử dụng tối đa</label>
                        <input type="number" class="form-control" th:field="*{usageLimit}" min="1">
                        <small class="form-text text-muted">Để trống nếu không giới hạn</small>
                    </div>
                    <!-- Ẩn trường perUserLimit và chỉ hiển thị thông báo -->
                    <div class="col-md-6 mb-3">

                        <!-- Giữ lại input ẩn để gửi giá trị mặc định là 1 về server -->
                        <input type="hidden" th:field="*{perUserLimit}" value="1">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h4>Áp dụng cho</h4>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="applyType" id="applyToCategories" value="categories" checked>
                        <label class="form-check-label" for="applyToCategories">Áp dụng cho ngành hàng</label>
                    </div>
                    <div id="categoriesSection" class="mt-2">
                        <select class="form-control select2" multiple="multiple" th:field="*{categoryIds}">
                            <!-- Categories will be loaded dynamically via AJAX -->
                        </select>
                        <small class="form-text text-muted">Chọn một hoặc nhiều ngành hàng</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="applyType" id="applyToProducts" value="products">
                        <label class="form-check-label" for="applyToProducts">Áp dụng cho sản phẩm cụ thể</label>
                    </div>
                    <div id="productsSection" class="mt-2" style="display: none;">
                        <select class="form-control select2" multiple="multiple" th:field="*{productIds}">
                            <!-- Products will be loaded dynamically via AJAX -->
                        </select>
                        <small class="form-text text-muted">Chọn một hoặc nhiều sản phẩm</small>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
                <a href="/seller/promotions" class="btn btn-secondary">Hủy</a>
                <button type="submit" class="btn btn-primary">Tạo khuyến mãi</button>
            </div>
        </form>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                placeholder: 'Chọn...',
                allowClear: true,
                width: '100%'
            });
            
            // Toggle between categories and products sections
            $('input[name="applyType"]').change(function() {
                if ($(this).val() === 'categories') {
                    $('#categoriesSection').show();
                    $('#productsSection').hide();
                } else {
                    $('#categoriesSection').hide();
                    $('#productsSection').show();
                }
            });
            
            // Load categories via AJAX
            $.ajax({
                url: '/api/seller/categories',
                method: 'GET',
                success: function(categories) {
                    const $select = $('select[th\:field*="categoryIds"]');
                    categories.forEach(function(category) {
                        $select.append(new Option(category.name, category.id));
                    });
                    $select.trigger('change');
                }
            });
            
            // Load products via AJAX when products tab is selected
            $('input[name="applyType"]').on('change', function() {
                if ($(this).val() === 'products') {
                    $.ajax({
                        url: '/api/seller/products',
                        method: 'GET',
                        success: function(products) {
                            const $select = $('select[th\:field*="productIds"]');
                            $select.empty();
                            products.forEach(function(product) {
                                $select.append(new Option(product.name, product.id));
                            });
                            $select.trigger('change');
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>
