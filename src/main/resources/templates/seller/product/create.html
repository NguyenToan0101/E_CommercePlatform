<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="seller/fragments/head :: head"></head>
<body>
<div class="dashboard-container">
    <div th:replace="seller/fragments/sidebar :: sidebar"></div>
    <main class="main-content product-create-page">
        <div th:replace="seller/fragments/header :: header"></div>
        <div class="form-container">
            <div class="page-header">
                <div class="page-header-content">
                    <div class="page-header-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="page-header-text">
                        <h2 th:text="${product.id} != null ? 'Chỉnh sửa sản phẩm' : 'Thêm sản phẩm mới'">
                            Thêm sản phẩm mới
                        </h2>
                        <p th:text="${product.id} != null ? 'Cập nhật thông tin sản phẩm của bạn' : 'Tạo sản phẩm mới cho cửa hàng'">
                            Tạo sản phẩm mới cho cửa hàng
                        </p>
                    </div>
                </div>
                <a th:href="@{/seller/products}" class="btn-back">
                    <i class="fas fa-arrow-left"></i>
                    Quay lại danh sách
                </a>
            </div>
            <form th:action="${product.id != null} ? @{/seller/products/edit/{id}(id=${product.id})} : @{/seller/products/save}"
                  method="post"
                  enctype="multipart/form-data"
                  th:object="${product}">
                <input type="hidden" th:field="*{status}" />
                <div class="form-group">
                    <label>Thông tin cơ bản:</label>
                    <div style="margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; padding: 15px; background: #f6f6f6">
                        <div class="form-group">
                            <label>Hình ảnh sản phẩm:</label>
                            <div class="product-image-upload-container">
                                <div class="product-image-upload-area" onclick="document.getElementById('imageFile').click()">
                                    <div class="upload-placeholder" id="upload-placeholder">
                                        <div class="plus-icon">+</div>
                                        <div class="upload-text">Thêm hình ảnh</div>
                                    </div>
                                    <div class="uploaded-images" id="uploaded-images" style="display: none;">
                                        <!-- Uploaded images will be displayed here -->
                                    </div>
                                </div>
                                <input type="file" id="imageFile" name="images" accept="image/*" multiple style="display: none;" onchange="handleProductImageUpload(this)">
                                <div th:if="${product.id != null and product.productimages != null}">
                                    <p>Ảnh hiện tại:</p>
                                    <div class="current-images">
                                        <div th:each="img,iterStat : ${product.productimages}" class="current-image-item">
                                            <img th:src="@{${img.imageurl}}" class="product-image-preview"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="name">Tên sản phẩm:</label>
                            <input type="text" id="name" th:field="*{name}" placeholder="Nhập tên sản phẩm" required minlength="1">
                            <div class="invalid-feedback">Tên sản phẩm không được để trống</div>
                        </div>

                        <div class="form-group">
                            <label for="category">Ngành hàng:</label>
                            <div class="category-selector">
                                <div class="category-display" onclick="openCategoryModal()">
                                    <span id="selected-category-text"
                                          th:class="${product.categoryid != null} ? '' : 'placeholder'"
                                          th:text="${product.categoryid != null} ? ${product.categoryid.categoryname} : '-- Chọn ngành hàng --'">
                                        -- Chọn ngành hàng --
                                    </span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <input type="hidden" id="category" th:field="*{categoryid.id}" required>
                            </div>
                            <div class="invalid-feedback">Vui lòng chọn ngành hàng</div>
                        </div>

                        <div class="form-group">
                            <label for="description">Mô tả sản phẩm:</label>
                            <textarea id="description" th:field="*{description}" placeholder="Nhập mô tả sản phẩm..."></textarea>
                            <div class="invalid-feedback">Mô tả không được để trống</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Thông tin bán hàng:</label>
                    <div style="margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; padding: 15px; background: #f6f6f6">
                        <div class="variant-group">
                            <label>Màu sắc:</label>
                            <div id="color-variant-container">
                                <!-- Dynamic color rows will be injected here by JavaScript -->
                            </div>
                            <button type="button" class="btn-secondary" onclick="addColorVariantRow()">+ Thêm màu</button>
                        </div>
                        <div class="variant-group">
                            <label>Kích thước:</label>
                             <div id="size-variant-container">
                                <!-- Dynamic size rows will be injected here by JavaScript -->
                            </div>
                            <button type="button" class="btn-secondary" onclick="addSizeVariantRow()">+ Thêm size</button>
                        </div>
                        <div class="variant-table-container">
                            <div class="variant-table-title">Danh sách phân loại hàng</div>
                            <table class="variant-table" id="variant-table">
                                    <thead>
                                    <tr>
                                        <th class="color-cell">Màu sắc</th>
                                        <th>Size</th>
                                        <th>Giá</th>
                                        <th>Số lượng</th>
                                        <th class="shipping-col" style="display:none;">* Cân nặng (Sau khi đóng gói)</th>
                                        <th class="shipping-col" style="display:none;">Kích thước đóng gói (cm)</th>
                                    </tr>
                                    </thead>
                                <tbody id="variant-tbody"></tbody>
                                </table>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Vận chuyển:</label>
                    <div style="margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; padding: 15px; background: #f6f6f6">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <label style="margin-right: 10px; font-weight: normal;">
                                <input type="checkbox" id="toggleShippingVariant" th:field="*{useVariantShipping}" th:checked="${product.useVariantShipping == true}"> Thiết lập cân nặng & kích thước cho từng phân loại
                            </label>
                        </div>
                        <div id="product-shipping-section">
                            <div class="form-group">
                                <label for="weight">* Cân nặng (Sau khi đóng gói)</label>
                                <input type="number" id="weight" th:field="*{weight}" placeholder="Nhập cân nặng" min="0.01" step='0.01' required> kg
                            </div>
                            <div class="form-group">
                                <label>Kích thước đóng gói (cm)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" th:field="*{length}" placeholder="Dài" min="0" required style="width: 80px;"> cm
                                    <input type="number" th:field="*{width}" placeholder="Rộng" min="0" required style="width: 80px;"> cm
                                    <input type="number" th:field="*{height}" placeholder="Cao" min="0" required style="width: 80px;"> cm
                                </div>
                            </div>
                        </div>
                        <div id="inventory-shipping-section" style="display: none;">
                            <div style="color: #888; font-size: 14px;">(Cân nặng & kích thước sẽ nhập ở từng phân loại bên dưới)</div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i>
                    <span th:text="${product.id} != null ? 'Cập nhật' : 'Lưu sản phẩm'"></span>
                </button>
            </form>
        </div>
    </main>
</div>

<!-- Category Selection Modal -->
<div id="category-modal" class="category-modal">
    <div class="category-modal-content">
        <div class="category-modal-header">
            <h3>Chọn ngành hàng</h3>
            <button class="close-btn" onclick="closeCategoryModal()">&times;</button>
        </div>
        <div class="category-modal-body">
            <div class="category-panel" id="level-1-panel">
                <div class="loading" id="level-1-loading">
                    <i class="fas fa-spinner fa-spin"></i> Đang tải...
                </div>
            </div>
            <div class="category-panel" id="level-2-panel" style="display: none;">
                <div class="loading" id="level-2-loading">
                    <i class="fas fa-spinner fa-spin"></i> Đang tải...
                </div>
            </div>
        </div>
        <div class="category-modal-footer">
            <div class="breadcrumb" id="breadcrumb">
                <span>Đã chọn:</span>
            </div>
            <button class="confirm-btn" id="confirm-btn" onclick="confirmCategorySelection()" disabled>
                Xác nhận
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>
<script th:inline="javascript">
    // Lấy dữ liệu inventories từ backend (nếu có) và parse thành mảng JS
    let inventoriesJsonString = /*[[${inventoriesJson}]]*/ '[]';
    let inventories = JSON.parse(inventoriesJsonString);

    ClassicEditor.create(document.querySelector('#description'), {
        toolbar: ['heading', '|', 'bold', 'italic', 'underline', '|', 'undo', 'redo']
    }).then(editor => {
        // Xóa chữ 'Rich Text Editor' nếu có
        if (editor.getData().trim() === 'Rich Text Editor') {
            editor.setData('');
        }
    }).catch(error => console.error(error));

    let colorInputIdCounter = 0;

    function addColorVariantRow(value = '', imageUrl = '') {
        const container = document.getElementById('color-variant-container');
        const row = document.createElement('div');
        row.className = 'variant-input-row';
        colorInputIdCounter++;
        const fileInputId = 'colorImageInput_' + colorInputIdCounter;
        row.innerHTML = `
            <input type="text" name="colorNames" placeholder="Tên màu (VD: Đỏ)" value="${value}" oninput="renderVariantTable()">
            <button type="button" class="btn-upload" onclick="document.getElementById('${fileInputId}').click()">Upload ảnh</button>
            <input type="file" name="colorImages" id="${fileInputId}" accept="image/*" style="display:none;" onchange="previewColorImage(this)">
            <img class="color-image-preview" src="${imageUrl}" alt="Xem trước" style="display:${imageUrl ? 'block' : 'none'};">
            <button type="button" class="variant-remove-btn" onclick="removeVariantRow(this)"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(row);
    }
    function addSizeVariantRow(value = '') {
        const container = document.getElementById('size-variant-container');
        const row = document.createElement('div');
        row.className = 'variant-input-row';
        row.innerHTML = `
            <input type="text" name="sizeNames" placeholder="Tên size (VD: M)" value="${value}" oninput="renderVariantTable()">
            <button type="button" class="variant-remove-btn" onclick="removeVariantRow(this)"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(row);
    }
    function removeVariantRow(button) {
        button.parentElement.remove();
        renderVariantTable();
    }
    function previewColorImage(input) {
        const preview = input.nextElementSibling; // The <img> tag
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.src = '';
            preview.style.display = 'none';
        }
    }
    function renderVariantTable() {
        const colors = Array.from(document.querySelectorAll('input[name="colorNames"]')).map(i => i.value.trim()).filter(Boolean);
        const sizes = Array.from(document.querySelectorAll('input[name="sizeNames"]')).map(i => i.value.trim()).filter(Boolean);
        const tbody = document.getElementById('variant-tbody');
        tbody.innerHTML = '';
        let idx = 0;
        const generateRow = (color, size) => {
             const row = document.createElement('tr');
                const colorCell = document.createElement('td');
                colorCell.className = 'color-cell';
                colorCell.textContent = color || '-';
                row.appendChild(colorCell);
                const sizeCell = document.createElement('td');
                sizeCell.textContent = size || '-';
                row.appendChild(sizeCell);
                const priceCell = document.createElement('td');
                priceCell.innerHTML = `<input type='number' name='inventories[${idx}].price' placeholder='Giá' min='0.01' step='0.01' required class='variant-input'>` +
                    `<input type='hidden' name='inventories[${idx}].dimension' value='${size || ''}'>` +
                    `<input type='hidden' name='inventories[${idx}].color' value='${color || ''}'>`;
                row.appendChild(priceCell);
                const stockCell = document.createElement('td');
                stockCell.innerHTML = `<input type='number' name='inventories[${idx}].quantity' placeholder='Số lượng' min='0' required class='variant-input'>`;
                row.appendChild(stockCell);
                // Shipping fields (weight, length, width, height) chỉ hiển thị nếu useVariantShipping=true
                const useVariantShipping = document.getElementById('toggleShippingVariant').checked;
                if (useVariantShipping) {
                    const shippingWeightCell = document.createElement('td');
                    shippingWeightCell.className = 'shipping-col';
                    shippingWeightCell.innerHTML = `<input type='number' name='inventories[${idx}].weight' placeholder='Cân nặng' min='0.01' step='0.01' required style='width:70px;'> Kg`;
                    row.appendChild(shippingWeightCell);
                    const shippingSizeCell = document.createElement('td');
                    shippingSizeCell.className = 'shipping-col';
                    shippingSizeCell.innerHTML = `
                        <input type='number' name='inventories[${idx}].length' placeholder='Dài' min='0' required style='width:50px;'> cm
                        <input type='number' name='inventories[${idx}].width' placeholder='Rộng' min='0' required style='width:50px;'> cm
                        <input type='number' name='inventories[${idx}].height' placeholder='Cao' min='0' required style='width:50px;'> cm
                    `;
                    row.appendChild(shippingSizeCell);
                }
                tbody.appendChild(row);
                idx++;
        };
        if (colors.length > 0 && sizes.length > 0) {
            colors.forEach(color => {
                sizes.forEach(size => generateRow(color, size));
            });
        } else if (colors.length > 0) {
            colors.forEach(color => generateRow(color, null));
        } else if (sizes.length > 0) {
            sizes.forEach(size => generateRow(null, size));
        }
        // Hiển thị/ẩn cột vận chuyển theo trạng thái useVariantShipping
        document.querySelectorAll('.shipping-col').forEach(col => {
            col.style.display = document.getElementById('toggleShippingVariant').checked ? '' : 'none';
        });
        document.querySelectorAll('.variant-table th.shipping-col').forEach(col => {
            col.style.display = document.getElementById('toggleShippingVariant').checked ? '' : 'none';
        });
    }

    // Category Selection Logic
    let selectedPath = [];
    let categoryCache = new Map();
    let rootCategories = /*[[${rootCategories}]]*/ [];

    async function initializeCategoryCache() {
        try {
            const response = await fetch('/api/categories/all');
            const allCategories = await response.json();
            allCategories.forEach(category => {
                categoryCache.set(category.id, category);
            });
            console.log('Category cache initialized with', allCategories.length, 'categories');
        } catch (error) {
            console.error('Error initializing category cache:', error);
        }
    }

    function openCategoryModal() {
        document.getElementById('category-modal').style.display = 'block';
        renderCategoryLevel(1, rootCategories);
    }

    function closeCategoryModal() {
        document.getElementById('category-modal').style.display = 'none';
    }

    function getChildCategoriesFromCache(parentId) {
        const children = [];
        categoryCache.forEach(category => {
            if (category.parentId === parentId) {
                children.push(category);
            }
        });
        return children;
    }

    async function loadSubCategories(parentId, level) {
        try {
            let categories = getChildCategoriesFromCache(parentId);
            if (categories.length === 0) {
                const response = await fetch(`/api/categories/children/${parentId}`);
                categories = await response.json();
                categories.forEach(category => {
                    categoryCache.set(category.id, category);
                });
            }
            renderCategoryLevel(level, categories);
            return categories;
        } catch (error) {
            console.error('Error loading subcategories:', error);
            const loadingEl = document.getElementById(`level-${level}-loading`);
            if (loadingEl) {
                loadingEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Lỗi tải dữ liệu';
            }
            return [];
        }
    }

    function renderCategoryLevel(level, categories) {
        const panel = document.getElementById(`level-${level}-panel`);
        const loading = document.getElementById(`level-${level}-loading`);
        if (loading) loading.style.display = 'none';
        panel.style.display = 'block';

        const existingItems = panel.querySelectorAll('.category-item');
        existingItems.forEach(item => item.remove());

        categories.forEach(category => {
            const item = document.createElement('div');
            item.className = 'category-item';
            item.innerHTML = `
                <span>${category.categoryname}</span>
                <i class="fas fa-chevron-right arrow"></i>
            `;
            item.onclick = (event) => selectCategory(category, level, event);
            panel.appendChild(item);
        });
    }

    async function selectCategory(category, level, event) {
        const currentPanel = document.getElementById(`level-${level}-panel`);
        currentPanel.querySelectorAll('.category-item').forEach(item => {
            item.classList.remove('active');
        });
        event.currentTarget.classList.add('active');

        selectedPath = selectedPath.slice(0, level - 1);
        selectedPath.push({ id: category.id, name: category.categoryname });

        for (let i = level + 1; i <= 3; i++) {
            const panel = document.getElementById(`level-${i}-panel`);
            if (panel) panel.style.display = 'none';
        }

        if (level < 3) {
            const nextLevel = level + 1;
            const nextLoading = document.getElementById(`level-${nextLevel}-loading`);
            if (nextLoading) nextLoading.style.display = 'flex';
            await loadSubCategories(category.id, nextLevel);
        }

        updateBreadcrumb();
        document.getElementById('confirm-btn').disabled = false;
    }

    function updateBreadcrumb() {
        const breadcrumb = document.getElementById('breadcrumb');
        let html = '<span>Đã chọn:</span>';
        selectedPath.forEach((item, index) => {
            if (index > 0) html += ' <span class="breadcrumb-separator">></span> ';
            else html += ' ';
            html += `<span class="breadcrumb-item">${item.name}</span>`;
        });
        breadcrumb.innerHTML = html;
    }

    function confirmCategorySelection() {
        if (selectedPath.length === 0) return;
        const lastSelected = selectedPath[selectedPath.length - 1];
        document.getElementById('selected-category-text').textContent =
            selectedPath.map(item => item.name).join(' > ');
        document.getElementById('selected-category-text').classList.remove('placeholder');
        document.getElementById('category').value = lastSelected.id;
        closeCategoryModal();
    }

    document.getElementById('category-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeCategoryModal();
        }
    });

    let selectedProductImages = [];

    function handleProductImageUpload(input) {
        const files = Array.from(input.files);
        const placeholder = document.getElementById('upload-placeholder');
        const uploadedImagesContainer = document.getElementById('uploaded-images');

        if (files.length > 0) {
            placeholder.style.display = 'none';
            uploadedImagesContainer.style.display = 'flex';

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedProductImages.push({
                        file: file,
                        url: e.target.result,
                        id: Date.now() + index
                    });

                    const imageItem = document.createElement('div');
                    imageItem.className = 'uploaded-image-item';
                    imageItem.innerHTML = `
                    <img src="${e.target.result}" alt="Product image">
                    <button type="button" class="remove-image-btn" onclick="removeProductImage(${Date.now() + index})">×</button>
                `;
                    uploadedImagesContainer.appendChild(imageItem);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    function removeProductImage(imageId) {
        selectedProductImages = selectedProductImages.filter(img => img.id !== imageId);
        const uploadedImagesContainer = document.getElementById('uploaded-images');
        const placeholder = document.getElementById('upload-placeholder');

        const imageItems = uploadedImagesContainer.querySelectorAll('.uploaded-image-item');
        imageItems.forEach(item => {
            const removeBtn = item.querySelector('.remove-image-btn');
            if (removeBtn && removeBtn.onclick.toString().includes(imageId)) {
                item.remove();
            }
        });

        if (selectedProductImages.length === 0) {
            placeholder.style.display = 'block';
            uploadedImagesContainer.style.display = 'none';
        }

        const fileInput = document.getElementById('imageFile');
        const dt = new DataTransfer();
        selectedProductImages.forEach(img => {
            dt.items.add(img.file);
        });
        fileInput.files = dt.files;
    }

    // Ẩn/hiện phần nhập vận chuyển tổng khi tích/bỏ checkbox useVariantShipping
    function updateShippingSectionDisplay() {
        const useVariantShipping = document.getElementById('toggleShippingVariant').checked;
        const productShippingSection = document.getElementById('product-shipping-section');
        productShippingSection.style.display = useVariantShipping ? 'none' : '';

        // Bỏ required khi ẩn, thêm required khi hiện
        productShippingSection.querySelectorAll('input').forEach(input => {
            if (useVariantShipping) {
                input.removeAttribute('required');
            } else {
                input.setAttribute('required', 'required');
            }
        });
    }
    document.getElementById('toggleShippingVariant').addEventListener('change', function() {
        updateShippingSectionDisplay();
        renderVariantTable();
    });

    // Lấy dữ liệu inventories từ backend (nếu có)
    // let inventories = /*[[${inventoriesJson}]]*/ []; // This line is removed as per the new_code

    function fillFormFromInventories(inventories) {
        // Xóa các dòng cũ
        document.getElementById('color-variant-container').innerHTML = '';
        document.getElementById('size-variant-container').innerHTML = '';

        // Lấy danh sách màu và ảnh duy nhất
        const colorMap = new Map();
        inventories.forEach(inv => {
            if (inv.color && !colorMap.has(inv.color)) {
                colorMap.set(inv.color, inv.image);
            }
        });
        const sizes = [...new Set(inventories.map(inv => inv.dimension).filter(Boolean))];

        // Thêm lại các dòng màu sắc với giá trị và ảnh có sẵn
        colorMap.forEach((imageUrl, color) => {
            addColorVariantRow(color, imageUrl || '');
        });


        // Thêm lại các dòng size với giá trị có sẵn
        sizes.forEach(size => addSizeVariantRow(size));

        // Render lại bảng phân loại
        renderVariantTable();

        // Gán giá trị cho từng dòng bảng phân loại
        inventories.forEach((inv, idx) => {
            // Giá
            const priceInput = document.querySelector(`input[name='inventories[${idx}].price']`);
            if (priceInput) priceInput.value = inv.price;
            // Kho
            const quantityInput = document.querySelector(`input[name='inventories[${idx}].quantity']`);
            if (quantityInput) quantityInput.value = inv.quantity;
            // Cân nặng, kích thước
            const weightInput = document.querySelector(`input[name='inventories[${idx}].weight']`);
            if (weightInput) weightInput.value = inv.weight;
            const lengthInput = document.querySelector(`input[name='inventories[${idx}].length']`);
            if (lengthInput) lengthInput.value = inv.length;
            const widthInput = document.querySelector(`input[name='inventories[${idx}].width']`);
            if (widthInput) widthInput.value = inv.width;
            const heightInput = document.querySelector(`input[name='inventories[${idx}].height']`);
            if (heightInput) heightInput.value = inv.height;
        });
    }

    let currentImages = [];
    // Lấy danh sách ảnh hiện tại từ DOM (nếu có)
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.current-image-item img').forEach(img => {
            currentImages.push(img.getAttribute('src'));
        });
        document.getElementById('currentImagesToKeep').value = currentImages.join(',');
    });
    function removeCurrentImage(idx) {
        // Ẩn ảnh khỏi giao diện
        document.querySelectorAll('.current-image-item')[idx].style.display = 'none';
        // Loại ảnh khỏi danh sách giữ lại
        currentImages[idx] = null;
        // Cập nhật input hidden để gửi lên backend
        document.getElementById('currentImagesToKeep').value = currentImages.filter(Boolean).join(',');
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (inventories && inventories.length > 0) {
            fillFormFromInventories(inventories);
        } else {
            addColorVariantRow();
            addSizeVariantRow();
            renderVariantTable();
        }
        updateShippingSectionDisplay();
    });
</script>
</body>
</html>
    