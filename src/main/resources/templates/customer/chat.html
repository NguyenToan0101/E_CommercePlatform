<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat với Shop</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .chat-container { display: flex; max-width: 1000px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); min-height: 500px; }
        .sidebar { width: 320px; border-right: 1px solid #e9ecef; padding: 0; background: #f6f7fb; border-radius: 12px 0 0 12px; }
        .sidebar-header { padding: 20px 16px 12px 16px; border-bottom: 1px solid #e9ecef; }
        .sidebar-header h3 { margin: 0; font-size: 18px; font-weight: 600; color: #1976d2; }
        .search-box { padding: 12px 16px; }
        .search-box input { width: 100%; padding: 8px 12px; border-radius: 20px; border: 1px solid #dee2e6; font-size: 14px; background: #fff; color: #495057; }
        .conversations-list { list-style: none; margin: 0; padding: 0; }
        .conversation-item { padding: 14px 18px; cursor: pointer; border-left: 3px solid transparent; display: flex; align-items: center; transition: all 0.2s; }
        .conversation-item.active, .conversation-item:hover { background: #e3f2fd; border-left: 3px solid #1976d2; }
        .conversation-avatar { width: 36px; height: 36px; border-radius: 50%; background: #1976d2; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 15px; margin-right: 12px; }
        .main-area { flex: 1; display: flex; flex-direction: column; border-radius: 0 12px 12px 0; }
        .chat-header { padding: 18px 24px; border-bottom: 1px solid #e9ecef; background: #f6f7fb; font-size: 17px; font-weight: 600; color: #1976d2; }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 18px 24px;
            background: #fafbfc;
            max-height: 420px;
            min-height: 180px;
        }
        .msg-me { text-align: right; color: #1976d2; }
        .msg-shop { text-align: left; color: #333; }
        .msg-content { display: inline-block; padding: 7px 16px; border-radius: 16px; margin: 2px 0; }
        .msg-me .msg-content { background: #e3f2fd; }
        .msg-shop .msg-content { background: #fff; border: 1px solid #eee; }
        .msg-time { display: block; font-size: 12px; color: #888; margin-top: 2px; }
        .chat-input { display: flex; gap: 8px; padding: 18px 24px; border-top: 1px solid #e9ecef; background: #fff; }
        .chat-input input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; }
        .chat-input button { padding: 10px 24px; border-radius: 20px; border: none; background: #1976d2; color: #fff; cursor: pointer; font-weight: 600; }
        .empty-chat { flex: 1; display: flex; align-items: center; justify-content: center; color: #aaa; font-size: 18px; }
        .msg-divider {
            text-align: center !important;
            color: #888;
            font-size: 13px;
            margin: 16px 0 8px 0;
            font-weight: 500;
            width: 100%;
            clear: both;
            display: block;
        }
        #msgList {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .msg-me {
            display: flex;
            justify-content: flex-end;
        }
        .msg-shop {
            display: flex;
            justify-content: flex-start;
        }
        .msg-content {
            max-width: 60%;
            padding: 7px 16px;
            border-radius: 16px;
            margin: 2px 0;
            word-break: break-word;
        }
        .msg-me .msg-content {
            background: #e3f2fd;
            color: #1976d2;
        }
        .msg-shop .msg-content {
            background: #fff;
            color: #333;
            border: 1px solid #eee;
        }
        /* Bong bóng chat */
        .msg-content {
            max-width: 60%;
            padding: 10px 18px;
            border-radius: 18px;
            margin: 2px 0;
            word-break: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            font-size: 15px;
            transition: background 0.2s;
        }
        .msg-me .msg-content {
            background: linear-gradient(135deg, #1976d2 80%, #42a5f5 100%);
            color: #fff;
            border: none;
        }
        .msg-shop .msg-content {
            background: #fff;
            color: #333;
            border: 1px solid #e3e3e3;
        }
        .msg-me, .msg-shop {
            align-items: flex-end;
        }
        /* Avatar tròn (nếu có) */
        .msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e3f2fd;
            color: #1976d2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        /* Input và nút gửi */
        .chat-input input {
            border: 1.5px solid #bdbdbd;
            transition: border 0.2s;
        }
        .chat-input input:focus {
            border: 1.5px solid #1976d2;
            outline: none;
        }
        .chat-input button {
            background: linear-gradient(135deg, #1976d2 80%, #42a5f5 100%);
            color: #fff;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(25,118,210,0.08);
            transition: background 0.2s;
        }
        .chat-input button:hover {
            background: #1565c0;
        }
        /* Responsive */
        @media (max-width: 600px) {
            .chat-container { flex-direction: column; min-height: 100vh; }
            .sidebar { width: 100%; border-radius: 12px 12px 0 0; }
            .main-area { border-radius: 0 0 12px 12px; }
            .msg-content { max-width: 90%; font-size: 14px; }
        }
    </style>
</head>
<body>
<div class="chat-container">
    <!-- Sidebar: Danh sách hội thoại -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Shop đã chat</h3>
        </div>
        <form class="search-box" th:action="@{/customer/chat/search}" method="get">
            <input type="text" name="shopName" placeholder="Tìm shop...">
        </form>
        <div class="start-chat-section" style="position:relative; margin-bottom:1rem;">
          <input type="text" id="shop-search-input" placeholder="Nhập tên shop để tìm..." autocomplete="off" style="width:100%;padding:8px;" />
          <div id="shop-search-results" class="search-results" style="display:block;"></div>
        </div>
        <ul class="conversations-list">
            <li th:each="conv : ${conversations}"
                th:classappend="${conversation != null and conv.id == conversation.id} ? 'conversation-item active' : 'conversation-item'">
                <a th:href="@{'/customer/chat?conversationId=' + ${conv.id}}" style="display:flex;align-items:center;text-decoration:none;color:inherit;">
                    <div class="conversation-avatar" th:text="${conv.sellerid.shop.shopname.substring(0,1)}"></div>
                    <span th:text="${conv.sellerid.shop.shopname}"></span>
                </a>
            </li>
        </ul>
        <div style="padding:16px 16px 0 16px;"><a th:href="@{/customer/chat}">Làm mới</a></div>
    </div>
    <!-- Main area: Khung chat -->
    <div class="main-area">
        <div th:if="${conversation == null}" class="empty-chat">
            <span>Chọn một shop để bắt đầu chat!</span>
        </div>
        <div th:if="${conversation != null}">
            <div class="chat-header" th:text="${conversation.sellerid.shop.shopname}"></div>
            <div class="messages" id="messages">
                <ul id="msgList" style="list-style:none;padding:0;margin:0;">
                    <th:block th:each="vw : ${messageViews}">
                        <th:block th:if="${vw.showDivider}">
                            <li class="msg-divider">
                                <span th:text="${#dates.format(vw.message.sentat, 'yyyyMMdd') == #dates.format(T(java.time.Instant).now(), 'yyyyMMdd') ? #dates.format(vw.message.sentat, 'HH:mm') :
                                                 #dates.dayOfWeekName(vw.message.sentat) == #dates.dayOfWeekName(T(java.time.Instant).now()) ? #dates.format(vw.message.sentat, 'HH:mm') + ' T' + #dates.format(vw.message.sentat, 'u') :
                                                 #dates.format(vw.message.sentat, 'HH:mm dd/MM/yyyy')}"></span>
                            </li>
                        </th:block>
                        <li th:classappend="${vw.message.senderid == conversation.customerid.id} ? 'msg-me' : 'msg-shop'">
                            <span class="msg-content" th:text="${vw.message.content}"></span>
                        </li>
                    </th:block>
                </ul>
            </div>
            <div class="chat-input">
                <input type="text" id="msgInput" placeholder="Nhập tin nhắn..." autocomplete="off" />
                <button id="sendBtn">Gửi</button>
            </div>
        </div>
    </div>
</div>
<script th:inline="javascript">
    // Realtime chỉ khởi tạo nếu có hội thoại đang chọn
    const conversationId = /*[[${conversation != null} ? ${conversation.id} : 0]]*/ 0;
    const customerId = /*[[${conversation != null} ? ${conversation.customerid.id} : 0]]*/ 0;
    const sellerId = /*[[${conversation != null} ? ${conversation.sellerid.id} : 0]]*/ 0;
    let stompClient = null;

    if (conversationId > 0) {
        function connectWS() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                stompClient.subscribe('/topic/conversation/' + conversationId, function(messageOutput) {
                    const msg = JSON.parse(messageOutput.body);
                    addMessage(msg); // Hiển thị tin nhắn realtime
                });
            });
        }

        function addMessage(msg) {
            const msgList = document.getElementById('msgList');
            // Lấy tin nhắn cuối cùng để so sánh ngày
            let lastMsg = msgList.lastElementChild && !msgList.lastElementChild.classList.contains('msg-divider') ? msgList.lastElementChild : null;
            let needDivider = false;
            if (!lastMsg) {
                needDivider = true;
            } else {
                const lastTime = lastMsg.dataset && lastMsg.dataset.sentat ? new Date(lastMsg.dataset.sentat) : null;
                const thisTime = new Date(msg.sentat);
                if (!lastTime || lastTime.toDateString() !== thisTime.toDateString()) {
                    needDivider = true;
                }
            }
            if (needDivider) {
                const divider = document.createElement('li');
                divider.className = 'msg-divider';
                divider.textContent = formatDivider(msg.sentat);
                msgList.appendChild(divider);
            }
            const li = document.createElement('li');
            li.className = (msg.senderid === customerId) ? 'msg-me' : 'msg-shop';
            li.dataset.sentat = msg.sentat;
            const span = document.createElement('span');
            span.className = 'msg-content';
            span.textContent = msg.content;
            li.appendChild(span);
            msgList.appendChild(li);
            msgList.scrollTop = msgList.scrollHeight;
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const pad = n => n < 10 ? '0' + n : n;
            return pad(date.getHours()) + ':' + pad(date.getMinutes()) + ', ' + pad(date.getDate()) + '/' + pad(date.getMonth() + 1) + '/' + date.getFullYear();
        }

        function formatDivider(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const pad = n => n < 10 ? '0' + n : n;
            const isToday = date.toDateString() === now.toDateString();
            const isThisWeek = (function() {
                const d = new Date(now);
                d.setHours(0,0,0,0);
                d.setDate(d.getDate() - d.getDay()); // Đầu tuần (Chủ nhật)
                const weekStart = d;
                d.setDate(d.getDate() + 6); // Cuối tuần (Thứ 7)
                const weekEnd = d;
                return date >= weekStart && date <= weekEnd;
            })();
            const weekdays = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            if (isToday) {
                return pad(date.getHours()) + ':' + pad(date.getMinutes());
            } else if (isThisWeek) {
                return pad(date.getHours()) + ':' + pad(date.getMinutes()) + ' ' + weekdays[date.getDay()];
            } else {
                return pad(date.getHours()) + ':' + pad(date.getMinutes()) + ' ' + pad(date.getDate()) + '/' + pad(date.getMonth() + 1) + '/' + date.getFullYear();
            }
        }

        document.getElementById('sendBtn').onclick = function() {
            sendMessage();
        };
        document.getElementById('msgInput').onkeydown = function(e) {
            if (e.key === 'Enter') sendMessage();
        };
        function sendMessage() {
            const input = document.getElementById('msgInput');
            const content = input.value.trim();
            if (!content) return;
            const msg = {
                senderid: customerId,
                receiverid: sellerId,
                content: content
            };
            stompClient.send('/app/chat.send/' + conversationId, {}, JSON.stringify(msg));
    
            input.value = '';
        }
        connectWS();
    }
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('shop-search-input');
  const results = document.getElementById('shop-search-results');
  let timeout = null;
  input.addEventListener('input', function() {
    clearTimeout(timeout);
    const query = input.value.trim();
    if (query.length < 2) {
      results.innerHTML = '';
      return;
    }
    timeout = setTimeout(() => {
      fetch(`/customer/chat/find-shop?shopName=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          results.innerHTML = '';
          if (data.length === 0) {
            results.innerHTML = '<div>Không tìm thấy shop phù hợp</div>';
            return;
          }
          data.forEach(shop => {
            const div = document.createElement('div');
            div.textContent = shop.shopname + (shop.status === 'ACTIVE' ? '' : ' (không hoạt động)');
            div.style.cursor = 'pointer';
            div.onclick = () => {
              fetch('/customer/chat/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `shopId=${shop.id}`
              }).then(() => {
                window.location.reload();
              });
            };
            results.appendChild(div);
          });
        });
    }, 300);
  });
  document.addEventListener('click', function(e) {
    if (!input.contains(e.target) && !results.contains(e.target)) {
      results.innerHTML = '';
    }
  });
});
</script>

<style>
.start-chat-section { margin-bottom: 1rem; }
.search-results {
  background: #fff;
  border: 1px solid #ddd;
  max-height: 200px;
  overflow-y: auto;
  position: absolute;
  z-index: 10;
  width: 100%;
}
.search-results div {
  padding: 8px 12px;
  cursor: pointer;
}
.search-results div:hover {
  background: #f0f0f0;
}
</style>
</body>
</html> 