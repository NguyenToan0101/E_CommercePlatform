<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xác nhận đơn hàng</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-teal: #0a4d68;
            --secondary-teal: #088395;
            --accent-teal: #05bfdb;
            --light-teal: #8de0a6;
            --white: #ffffff;
            --light-gray: #f8f9fa;
            --border-gray: #e5e7eb;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --error-red: #dc2626;
            --warning-orange: #f59e0b;
            --success-green: #10b981;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
            --shadow-heavy: rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-teal) 0%, var(--light-teal) 100%);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow-heavy);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-teal), var(--secondary-teal));
            color: var(--white);
            padding: 40px 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .logo-placeholder {
            width: 120px;
            height: 60px;
            background: var(--white);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: var(--primary-teal);
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 40px 30px;
        }

        .customer-section {
            background: linear-gradient(135deg, var(--primary-teal), var(--secondary-teal));
            color: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .customer-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></svg>');
            opacity: 0.3;
        }

        .customer-content {
            position: relative;
            z-index: 1;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .section-subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .info-sections {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .info-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .info-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-section h3::after {
            content: '';
            width: 20px;
            height: 2px;
            background: var(--accent-teal);
            border-radius: 1px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 12px 0;
        }

        .address-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .address-selection .info-value {
            flex: 1;
            min-width: 150px;
        }

        .info-item i {
            color: var(--accent-teal);
            width: 20px;
            font-size: 16px;
        }

        .info-label {
            font-weight: 500;
            min-width: 80px;
            opacity: 0.9;
        }

        .info-value input,
        .info-value select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-dark);
            background: var(--white);
        }

        .info-value input#address {
            min-width: 500px; /* Increased width for address input */
        }

        .wallet-notification {
            background: linear-gradient(135deg, var(--accent-teal), var(--light-teal));
            color: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(5, 191, 219, 0.3);
            position: relative;
        }

        .wallet-notification h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .wallet-notification p {
            opacity: 0.9;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .wallet-btn {
            background: var(--white);
            color: var(--primary-teal);
            border: 2px solid var(--white);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .wallet-btn:hover {
            background: var(--primary-teal);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .warning {
            background: linear-gradient(135deg, #fef3cd, #fbbf24);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
            color: #92400e;
        }

        .warning-content {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .warning i {
            color: var(--warning-orange);
            font-size: 20px;
        }

        .warning a {
            color: var(--primary-teal);
            text-decoration: none;
            font-weight: 600;
            border-bottom: 1px solid transparent;
            transition: border-color 0.3s ease;
        }

        .warning a:hover {
            border-bottom-color: var(--primary-teal);
        }

        .section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, var(--light-gray), var(--white));
            border-radius: 12px;
            border-left: 4px solid var(--primary-teal);
        }

        .section-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section-header h2 {
            color: var(--primary-teal);
            font-size: 24px;
            font-weight: 600;
        }

        .section-header i {
            color: var(--secondary-teal);
            font-size: 24px;
        }

        .total-amount {
            background: linear-gradient(135deg, var(--primary-teal), var(--secondary-teal));
            color: var(--white);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(10, 77, 104, 0.3);
        }

        .table-container {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px var(--shadow-light);
            border: 1px solid var(--border-gray);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, var(--primary-teal), var(--secondary-teal));
            color: var(--white);
        }

        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid var(--border-gray);
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: linear-gradient(135deg, var(--light-gray), var(--white));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-light);
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        td {
            padding: 18px 15px;
            vertical-align: middle;
        }

        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid var(--border-gray);
            box-shadow: 0 4px 12px var(--shadow-light);
        }

        .product-name {
            font-weight: 600;
            color: var(--text-dark);
            max-width: 200px;
            line-height: 1.4;
        }

        .product-variant {
            color: var(--text-gray);
            font-size: 14px;
            margin-top: 4px;
        }

        .price {
            font-weight: 700;
            color: var(--primary-teal);
            font-size: 16px;
        }

        .quantity {
            background: linear-gradient(135deg, var(--accent-teal), var(--light-teal));
            color: var(--white);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            text-align: center;
            min-width: 50px;
            box-shadow: 0 4px 12px rgba(5, 191, 219, 0.3);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-align: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-teal), var(--secondary-teal));
            color: var(--white);
            box-shadow: 0 8px 24px rgba(10, 77, 104, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--secondary-teal), var(--accent-teal));
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(10, 77, 104, 0.4);
        }

        .btn-link {
            background: none;
            color: var(--primary-teal);
            border: 2px solid var(--primary-teal);
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-link:hover {
            background: var(--primary-teal);
            color: var(--white);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(10, 77, 104, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .form-actions {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid var(--border-gray);
        }

        .hidden {
            display: none !important;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 12px 40px var(--shadow-medium);
            border-left: 4px solid var(--success-green);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            min-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            border-left-color: var(--error-red);
        }

        .notification.warning {
            border-left-color: var(--warning-orange);
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification i {
            font-size: 20px;
        }

        .notification.error i {
            color: var(--error-red);
        }

        .notification.warning i {
            color: var(--warning-orange);
        }

        .notification.success i {
            color: var(--success-green);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 16px;
            }

            .content {
                padding: 20px;
            }

            .info-sections {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 600px;
            }

            .form-actions {
                flex-direction: column;
                gap: 15px;
            }

            .btn {
                width: 100%;
            }

            .notification {
                right: 10px;
                left: 10px;
                min-width: auto;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .total-amount {
                align-self: stretch;
                text-align: center;
            }

            .address-selection {
                flex-direction: column;
                align-items: stretch;
            }

            .address-selection .info-value {
                min-width: 100%;
            }

            .info-value input#address {
                min-width: 100%; /* Ensure full width on mobile */
            }


        }
    </style>
    <script>
        function validateInfo() {
            const firstName = document.getElementById("firstname").value.trim();
            const lastName = document.getElementById("lastname").value.trim();
            const phone = document.getElementById("phone").value.trim();
            const address = document.getElementById("address").value.trim();
            const phoneValid = /^[0-9]{9,11}$/.test(phone);
            const addressValid = address.length > 10 && /\d+/.test(address);
            const firstNameValid = firstName.length > 0;
            const lastNameValid = lastName.length > 0;

            const cartBtn = document.getElementById("cartSubmitBtn");
            const buyNowBtns = document.querySelectorAll(".buyNowBtn");
            const warning = document.getElementById("warning");

            if (!firstNameValid || !lastNameValid || !phoneValid || !addressValid) {
                if (cartBtn) {
                    cartBtn.disabled = true;
                    cartBtn.classList.add('loading');
                }
                buyNowBtns.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('loading');
                });
                warning.style.display = "block";
            } else {
                if (cartBtn) {
                    cartBtn.disabled = false;
                    cartBtn.classList.remove('loading');
                }
                buyNowBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('loading');
                });
                warning.style.display = "none";
            }
        }

        function calculateCartTotal() {
            const cartRows = document.querySelectorAll("#cartItemsTable tbody tr");
            let total = 0;

            cartRows.forEach(row => {
                const priceText = row.querySelector('.price').textContent.replace(/[^\d]/g, '');
                const quantity = parseInt(row.querySelector('.quantity').textContent);
                total += parseInt(priceText) * quantity;
            });

            return total;
        }

        function calculateBuyNowTotal() {
            const buyNowRows = document.querySelectorAll("#buyNowItemsTable tbody tr");
            let total = 0;

            buyNowRows.forEach(row => {
                const priceText = row.querySelector('.price').textContent.replace(/[^\d]/g, '');
                const quantity = parseInt(row.querySelector('.quantity').textContent);
                total += parseInt(priceText) * quantity;
            });

            return total;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function updateTotals() {
            // Update cart total
            const cartTotal = calculateCartTotal();
            const cartTotalElement = document.getElementById('cartTotal');
            if (cartTotalElement && cartTotal > 0) {
                cartTotalElement.textContent = `Tổng: ${formatCurrency(cartTotal)}`;
            }

            // Update buy now total
            const buyNowTotal = calculateBuyNowTotal();
            const buyNowTotalElement = document.getElementById('buyNowTotal');
            if (buyNowTotalElement && buyNowTotal > 0) {
                buyNowTotalElement.textContent = `Tổng: ${formatCurrency(buyNowTotal)}`;
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            const iconClass = type === 'error' ? 'fa-exclamation-circle' :
                type === 'warning' ? 'fa-exclamation-triangle' :
                    'fa-check-circle';

            notification.innerHTML = `
            <div class="notification-content">
                <i class="fas ${iconClass}"></i>
                <span>${message}</span>
            </div>
        `;

            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        async function fetchProvinces() {
            try {
                const response = await fetch('https://provinces.open-api.vn/api/p/');
                const provinces = await response.json();
                const provinceSelect = document.getElementById('province');
                provinceSelect.innerHTML = '<option value="">Chọn Tỉnh/Thành phố</option>';
                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.code;
                    option.textContent = province.name;
                    provinceSelect.appendChild(option);
                });
            } catch (error) {
                showNotification('Không thể tải danh sách Tỉnh/Thành phố.', 'error');
            }
        }

        async function fetchDistricts(provinceCode) {
            try {
                const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
                const data = await response.json();
                const districtSelect = document.getElementById('district');
                districtSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
                data.districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.code;
                    option.textContent = district.name;
                    districtSelect.appendChild(option);
                });
                districtSelect.disabled = false;
            } catch (error) {
                showNotification('Không thể tải danh sách Quận/Huyện.', 'error');
            }
        }

        async function fetchWards(districtCode) {
            try {
                const response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
                const data = await response.json();
                const wardSelect = document.getElementById('ward');
                wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
                data.wards.forEach(ward => {
                    const option = document.createElement('option');
                    option.value = ward.name;
                    option.textContent = ward.name;
                    wardSelect.appendChild(option);
                });
                wardSelect.disabled = false;
            } catch (error) {
                showNotification('Không thể tải danh sách Phường/Xã.', 'error');
            }
        }

        function updateAddressFromDropdowns() {
            const provinceSelect = document.getElementById('province');
            const districtSelect = document.getElementById('district');
            const wardSelect = document.getElementById('ward');
            const houseNumberInput = document.getElementById('houseNumber');
            const addressInput = document.getElementById('address');

            const province = provinceSelect.options[provinceSelect.selectedIndex]?.text || '';
            const district = districtSelect.options[districtSelect.selectedIndex]?.text || '';
            const ward = wardSelect.options[wardSelect.selectedIndex]?.text || '';
            const houseNumber = houseNumberInput.value.trim();

            if (province && district && ward && houseNumber) {
                addressInput.value = `${houseNumber}, ${ward}, ${district}, ${province}`;
            }
            validateInfo();
        }

        function resetDropdowns() {
            const provinceSelect = document.getElementById('province');
            const districtSelect = document.getElementById('district');
            const wardSelect = document.getElementById('ward');
            const houseNumberInput = document.getElementById('houseNumber');

            provinceSelect.value = '';
            districtSelect.value = '';
            districtSelect.disabled = true;
            wardSelect.value = '';
            wardSelect.disabled = true;
            houseNumberInput.value = '';
        }

        document.addEventListener("DOMContentLoaded", function () {
            const inputs = document.querySelectorAll('.info-value input, .info-value select');
            inputs.forEach(input => {
                input.addEventListener('input', validateInfo);
            });

            validateInfo();

            // Initialize address selection
            fetchProvinces();
            const provinceSelect = document.getElementById('province');
            const districtSelect = document.getElementById('district');
            const wardSelect = document.getElementById('ward');
            const houseNumberInput = document.getElementById('houseNumber');
            const addressInput = document.getElementById('address');

            provinceSelect.addEventListener('change', function () {
                districtSelect.disabled = true;
                wardSelect.disabled = true;
                wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
                if (this.value) {
                    fetchDistricts(this.value);
                } else {
                    districtSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
                    districtSelect.disabled = true;
                }
                updateAddressFromDropdowns();
            });

            // Chạy khi load trang, nếu muốn mặc định là không có voucher
            if (!localStorage.getItem('voucherSelected')) {
                localStorage.removeItem('freeshipId');
                localStorage.removeItem('discountId');
            }

            async function sendAddressToBackendAndUpdatePreview() {
                const provinceSelect = document.getElementById('province');
                const districtSelect = document.getElementById('district');


                const provinceCode = provinceSelect.value;
                const districtCode = districtSelect.value;

                const provinceName = provinceSelect.options[provinceSelect.selectedIndex]?.text || '';
                const districtName = districtSelect.options[districtSelect.selectedIndex]?.text || '';

                const data = {
                    provinceCode: provinceCode,
                    provinceName: provinceName,
                    districtCode: districtCode,
                    districtName: districtName,

                };

                try {
                    // Gửi địa chỉ
                    const response = await fetch('/checkout/address', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        throw new Error('Lỗi khi gửi địa chỉ');
                    }

                    // Sau khi gửi địa chỉ, gọi lại preview realtime để lấy phí ship
                    await fetchPreviewRealtime();
                } catch (error) {
                    console.error(error);
                    showNotification('Không thể gửi địa chỉ về server', 'error');
                }
            }

            // async function fetchPreviewRealtime() {
            //     const inventory = localStorage.getItem('inventory');
            //     const quantity = localStorage.getItem('quantity') ;
            //     if (!inventory) {
            //         console.error('Thiếu inventory để gọi preview');
            //         return;
            //     }
            //     try {
            //         const response = await fetch(`/checkout/preview_realtime_data?inventory=${inventory}&quantity=${quantity}`);
            //         const data = await response.json();
            //
            //         // Gắn lại dữ liệu vào giao diện
            //         document.getElementById('feeShip').innerText = data.feeShip + ' đ';
            //         document.getElementById('totalPrice').innerText = data.priceTotal + ' đ';
            //         document.getElementById('timeDelivery').innerText = data.timeDelivery ;
            //     } catch (error) {
            //         console.error('Lỗi khi gọi preview realtime:', error);
            //     }
            // }
            async function fetchPreviewRealtime() {
                const inventory = localStorage.getItem('inventory');
                const quantity = localStorage.getItem('quantity');
                const freeshipId = localStorage.getItem('freeshipId');
                const discountId = localStorage.getItem('discountId');

                if (!inventory || !quantity) {
                    console.error('Thiếu inventory hoặc quantity để gọi preview');
                    return;
                }

                const url = new URL('/checkout/preview_realtime_data', window.location.origin);
                url.searchParams.append('inventory', inventory);
                url.searchParams.append('quantity', quantity);
                // if (freeshipId) url.searchParams.append('freeshipId', freeshipId);
                // if (discountId) url.searchParams.append('discountId', discountId);
                if (freeshipId && freeshipId !== "null") {
                    url.searchParams.append('freeshipId', freeshipId);
                }
                if (discountId && discountId !== "null") {
                    url.searchParams.append('discountId', discountId);
                }
                try {
                    const response = await fetch(url.toString());
                    const data = await response.json();

                    document.getElementById('feeShip').innerText = data.feeShip + ' đ';
                    document.getElementById('totalPrice').innerText = data.priceTotal + ' đ';
                    document.getElementById('timeDelivery').innerText = data.timeDelivery;
                    document.getElementById('feeShipVoucher').innerText = data.feeShipVoucher + ' đ';
                    document.getElementById('discountVoucher').innerText = data.discountVoucher + ' đ';
                } catch (error) {
                    console.error('Lỗi khi gọi preview realtime:', error);
                }
            }

            wardSelect.addEventListener('change', function () {
                updateAddressFromDropdowns();
                sendAddressToBackendAndUpdatePreview();
            });
            const modal = document.getElementById("voucherModal");
            const openBtn = document.getElementById("openModalBtn");
            const closeBtn = document.getElementById("closeModalBtn");
            const cancelBtn = document.getElementById("cancelBtn");
            const confirmBtn = document.getElementById("confirmBtn");

            // Mở/tắt modal
            openBtn.onclick = () => modal.classList.remove("hidden");
            closeBtn.onclick = () => modal.classList.add("hidden");
            cancelBtn.onclick = () => modal.classList.add("hidden");

            // Nút OK
//     confirmBtn.onclick = () => {
//         const selectedFree = document.querySelector('input[name="freeship"]:checked');
//         const selectedDiscount = document.querySelector('input[name="discount"]:checked');
//
//         alert(`Voucher bạn chọn:
// - Freeship: ${selectedFree ? "✅ Có" : "❌ Không"}
// - Discount: ${selectedDiscount ? "✅ Có" : "❌ Không"}`);
//
//         modal.classList.add("hidden");
//     };
            confirmBtn.onclick = () => {
                const selectedFree = document.querySelector('input[name="freeship"]:checked');
                const selectedDiscount = document.querySelector('input[name="discount"]:checked');

                const freeshipId = selectedFree ? selectedFree.value : null;
                const discountId = selectedDiscount ? selectedDiscount.value : null;

                // Lưu vào localStorage
                if (freeshipId !== null) {
                    localStorage.setItem('freeshipId', freeshipId);
                } else {
                    localStorage.removeItem('freeshipId');
                }

                if (discountId !== null) {
                    localStorage.setItem('discountId', discountId);
                } else {
                    localStorage.removeItem('discountId');
                }


                alert(`Voucher bạn chọn:\n- Freeship: ${freeshipId ? "✅ Có" : "❌ Không"}\n- Discount: ${discountId ? "✅ Có" : "❌ Không"}`);

                modal.classList.add("hidden");

                // Gọi lại preview
                fetchPreviewRealtime();
            };


            // Tab switching
            const tabButtons = document.querySelectorAll(".tab-btn");
            const tabContents = document.querySelectorAll(".tab-content");

            tabButtons.forEach((btn) => {
                btn.addEventListener("click", () => {
                    // Bỏ active tab
                    tabButtons.forEach((b) => b.classList.remove("active-tab", "bg-white/30"));
                    tabContents.forEach((c) => c.classList.add("hidden"));

                    // Kích hoạt tab mới
                    btn.classList.add("active-tab", "bg-white/30");
                    const tabId = btn.getAttribute("data-tab");
                    document.getElementById(`tab-${tabId}`).classList.remove("hidden");
                });
            });


            districtSelect.addEventListener('change', function () {
                wardSelect.disabled = true;
                if (this.value) {
                    fetchWards(this.value);
                } else {
                    wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
                }
                updateAddressFromDropdowns();
            });


            houseNumberInput.addEventListener('input', updateAddressFromDropdowns);

            // Allow manual address input and reset dropdowns when address is edited
            addressInput.addEventListener('input', function () {
                resetDropdowns();
                validateInfo();
            });

            // Hide cart items section if no items with id != null
            const cartRows = document.querySelectorAll("#cartItemsTable tbody tr");
            if (cartRows.length === 0) {
                document.getElementById("cartItemsContainer").classList.add("hidden");
            }

            // Hide buy now items section if no items with id == null
            const buyNowRows = document.querySelectorAll("#buyNowItemsTable tbody tr");
            if (buyNowRows.length === 0) {
                document.getElementById("buyNowItemsContainer").classList.add("hidden");
            }


            // Calculate and display totals
            updateTotals();

            // Show welcome notification
            setTimeout(() => {
                showNotification('Thông tin đơn hàng đã được tải thành công!', 'success');
            }, 500);


        });
    </script>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-content">
            <div class="logo-placeholder">
                <span>YOUR LOGO</span>
            </div>
            <h1><i class="fas fa-shopping-cart"></i> Xác nhận đơn hàng</h1>
            <p>Vui lòng kiểm tra thông tin và xác nhận thanh toán</p>
        </div>
    </div>

    <div class="content">
        <!-- Customer Information Section -->
        <div class="customer-section">
            <div class="customer-content">
                <h2 class="section-title">Thông tin cá nhân</h2>
                <p class="section-subtitle">Vui lòng nhập thông tin liên hệ của bạn</p>

                <div class="info-sections">
                    <div class="info-section">
                        <h3><i class="fas fa-address-book"></i> Thông tin liên hệ</h3>
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <span class="info-label">HỌ:</span>
                            <div class="info-value">
                                <input type="text" id="firstname" name="firstname" th:value="${customer.firstname}"
                                       placeholder="Nhập họ" required/>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <span class="info-label">TÊN:</span>
                            <div class="info-value">
                                <input type="text" id="lastname" name="lastname" th:value="${customer.lastname}"
                                       placeholder="Nhập tên" required/>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-phone"></i>
                            <span class="info-label">ĐIỆN THOẠI:</span>
                            <div class="info-value">
                                <input type="text" id="phone" name="phone" th:value="${customer.phone}"
                                       placeholder="Nhập số điện thoại" required/>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span class="info-label">ĐỊA CHỈ:</span>
                            <div class="info-value" style="display: flex; align-items: center; gap: 10px;">
                                <input type="text" id="address" name="address" th:value="${customer.address}"
                                       placeholder="Nhập địa chỉ hoặc chọn trên bản đồ" required style="flex:1; min-width:0;"/>
                                <button type="button" id="openMapBtn" style="padding: 10px 16px; border-radius: 8px; background: linear-gradient(135deg, #088395, #05bfdb); color: #fff; border: none; font-weight: 600; cursor: pointer; transition: background 0.2s;">Chọn vị trí trên bản đồ</button>
                            </div>
                            <small style="margin-left: 44px; color: #6b7280;">Nhấn vào nút để chọn vị trí trên bản đồ hoặc nhập thủ công.</small>
                        </div>
                    </div>
                </div>

                <div id="warning" class="warning">
                    <div class="warning-content">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Thông tin liên hệ chưa hợp lệ. Vui lòng nhập đầy đủ và chính xác thông tin trước khi thanh toán.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wallet Payment Notification -->
        <div class="wallet-notification">
            <h3><i class="fas fa-wallet"></i> Thanh toán bằng Ví của bạn</h3>
            <p>Sử dụng số dư trong ví điện tử để thanh toán đơn hàng một cách nhanh chóng và an toàn</p>
            <a href="/wallet" class="wallet-btn">
                <i class="fas fa-eye"></i>
                Xem ví
            </a>
        </div>

        <!-- Cart Items Section -->
        <div id="cartItemsContainer" class="section">
            <div class="section-header">
                <div class="section-header-left">
                    <i class="fas fa-shopping-basket"></i>
                    <h2>Danh sách sản phẩm trong giỏ hàng</h2>
                </div>
                <div class="total-amount" id="cartTotal">
                    <i class="fas fa-calculator"></i>
                    Tổng: 0 đ
                </div>
            </div>

            <div class="table-container">
                <form th:action="@{/checkout}" method="post">
                    <!-- Customer Info Inputs -->
                    <input type="hidden" id="cartFirstName" name="firstname"/>
                    <input type="hidden" id="cartLastName" name="lastname"/>
                    <input type="hidden" id="cartPhone" name="phone"/>
                    <input type="hidden" id="cartAddress" name="address"/>

                    <table id="cartItemsTable">
                        <thead>
                        <tr>
                            <th><i class="fas fa-image"></i> Hình ảnh</th>
                            <th><i class="fas fa-tag"></i> Tên sản phẩm</th>
                            <th><i class="fas fa-palette"></i> Màu</th>
                            <th><i class="fas fa-ruler"></i> Phân loại</th>
                            <th><i class="fas fa-dollar-sign"></i> Giá</th>
                            <th><i class="fas fa-sort-numeric-up"></i> Số lượng</th>
                            <th><i class="fas fa-cog"></i> Hành động</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="item : ${items}" th:if="${item.id != null}">
                            <td>
                                <img th:src="${item.imageUrl}" alt="Product Image" class="product-image"/>
                            </td>
                            <td>
                                <div class="product-name" th:text="${item.productName}"></div>
                            </td>
                            <td>
                                <span class="product-variant" th:text="${item.color ?: '-'}"></span>
                            </td>
                            <td>
                                <span class="product-variant" th:text="${item.dimension ?: '-'}"></span>
                            </td>
                            <td>
                                <span class="price"
                                      th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + ' đ'"></span>
                            </td>
                            <td>
                                <span class="quantity" th:text="${item.quantity}"></span>
                            </td>
                            <td>
                                <input type="hidden" name="cartItemIds" th:value="${item.id}"/>
                                <span style="color: var(--primary-teal); font-weight: 600;">
                  <i class="fas fa-credit-card"></i> Thanh toán chung
                </span>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <div class="form-actions">
                        <button id="cartSubmitBtn" type="submit" class="btn btn-primary">
                            <i class="fas fa-check-circle"></i>
                            Xác nhận thanh toán giỏ hàng
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Buy Now Items Section -->
        <div id="buyNowItemsContainer" class="section">
            <div class="section-header">
                <div class="section-header-left">
                    <i class="fas fa-bolt"></i>
                    <h2>Danh sách sản phẩm mua ngay</h2>
                </div>
                <div class="total-amount" id="buyNowTotal">
                    <i class="fas fa-calculator"></i>
                    Tổng: 0 đ
                </div>
            </div>

            <!-- Voucher -->
            <!--      <body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-500 via-pink-400 to-yellow-300">-->

            <!-- Nút mở modal -->
            <button id="openModalBtn" class="px-6 py-3 bg-orange-500 text-white rounded-md hover:bg-orange-600">
                Chọn voucher
            </button>

            <!-- Modal -->

            <!-- Nền mờ -->
            <div id="voucherModal" class="fixed inset-0 z-50 hidden">
                <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm"></div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2
                         z-10 w-[500px] rounded-xl p-6 shadow-lg bg-white/20
                         backdrop-blur-md border border-white/30 text-white">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Chọn Musa Voucher</h3>
                        <button id="closeModalBtn" class="text-2xl font-bold hover:text-red-400">&times;</button>
                    </div>

                    <!-- Tabs -->
                    <div class="flex space-x-2 mb-4">
                        <button data-tab="freeship"
                                class="tab-btn active-tab px-3 py-1 rounded bg-white/30 hover:bg-white/40">Freeship
                        </button>
                        <button data-tab="discount" class="tab-btn px-3 py-1 rounded bg-white/10 hover:bg-white/30">
                            Discount
                        </button>
                    </div>

                    <!-- Voucher List -->
                    <div class="max-h-96 overflow-y-auto space-y-4 text-sm">
                        <!-- Freeship tab -->
                        <div class="tab-content" id="tab-freeship">
                            <label th:each="promo : ${voucherFreeShip}"
                                   th:classappend="${price < promo.getMinOrderValue()} ? 'opacity-50 cursor-not-allowed' : ''"
                                   class="flex items-center p-4 bg-white/10 border border-white/20 rounded-lg hover:bg-white/20 transition space-x-4">

                                <div class="flex-[3] bg-teal-500 text-white font-bold px-3 py-2 rounded break-words whitespace-normal overflow-hidden flex flex-col items-center justify-center text-center">
                                    <img th:src="@{/images/freeship.png}" alt="Logo" />

                                    <p th:text="${promo.getName()}"  class="text-xs">Freeship</p>
                                </div>


                                <div class="flex-[7] min-w-0 text-white text-sm space-y-1  ">

                                    <p th:text="'Giảm tối đa ' + ${promo.getMaxDiscount() / 1000} + 'k'">
                                        Giảm tối đa ...
                                    </p>

                                    <!-- Đơn tối thiểu - chuyển sang xxxk -->
                                    <p th:text="'Đơn tối thiểu ' + ${promo.getMinOrderValue() / 1000} + 'k'">
                                        Đơn tối thiểu ...
                                    </p>

                                    <!-- Hiển thị phần trăm sử dụng nếu vượt 70% -->
                                    <p th:if="${promo.getUsageCount() != null and promo.getUsageLimit() != null and (promo.getUsageCount() * 100.0 / promo.getUsageLimit()) > 70}"
                                       th:text="'Đã dùng ' + ${#numbers.formatDecimal(promo.getUsageCount() * 100.0 / promo.getUsageLimit(), 0, 1)} + '%'">
                                        Đã dùng ...
                                    </p>

                                    <!-- Nếu còn dưới 24 giờ -->
                                    <p class="text-xs text-white/70"
                                       th:if="${T(java.time.Duration).between(T(java.time.LocalDateTime).now(), promo.enddate).toHours() < 24}"
                                       th:text="'Hết hạn trong ' + ${T(java.time.Duration).between(T(java.time.LocalDateTime).now(), promo.enddate).toHours()} + 'h'">
                                        Hết hạn trong ...
                                    </p>

                                    <!-- Nếu trên 24 giờ -->
                                    <p class="text-xs text-white/70"
                                       th:unless="${T(java.time.Duration).between(T(java.time.LocalDateTime).now(), promo.enddate).toHours() < 24}"
                                       th:text="'Hết hạn lúc ' + ${#temporals.format(promo.enddate, 'dd/MM/yyyy HH:mm')}">
                                        Hết hạn lúc ...
                                    </p>
                                </div>
                                <input type="radio" name="freeship" class="mt-2" th:value="${promo.getId()}"
                                       th:disabled="${price < promo.getMinOrderValue()}"
                                />
                            </label>
                        </div>

                        <!-- Discount tab -->
                        <div class="tab-content hidden" id="tab-discount">
                            <label th:each="promo : ${voucherDiscount}"
                                   th:classappend="${price < promo.getMinOrderValue()} ? 'opacity-50 cursor-not-allowed' : ''"
                                   class="flex items-center p-4 bg-white/10 border border-white/20 rounded-lg hover:bg-white/20 transition space-x-4">

                                <!-- Phần getName chiếm 3/10 -->
                                <div class="flex-[3] bg-orange-400 text-white font-bold px-3 py-2 rounded break-words whitespace-normal overflow-hidden flex flex-col items-center justify-center text-center">
                                    <img th:src="@{/images/discount.png}" alt="Logo" class="mb-1" />
                                    <p th:text="${promo.getName()}" class="text-xs">SALE</p>
                                </div>


                                <!-- Phần thông tin chiếm 7/10 -->
                                <div class="flex-[7] min-w-0 text-white text-sm space-y-1  ">

                                    <!-- Hiển thị giảm % nếu là loại PERCENTAGE -->
                                    <p th:if="${promo.getType() == 'PERCENTAGE'}"
                                       th:text="'Giảm ' + ${promo.getValue()} + '%'">
                                        Giảm X%
                                    </p>

                                    <!-- Giảm tối đa - chuyển sang xxxk -->
                                    <p th:text="'Giảm tối đa ' + ${promo.getMaxDiscount() / 1000} + 'k'">
                                        Giảm tối đa ...
                                    </p>

                                    <!-- Đơn tối thiểu - chuyển sang xxxk -->
                                    <p th:text="'Đơn tối thiểu ' + ${promo.getMinOrderValue() / 1000} + 'k'">
                                        Đơn tối thiểu ...
                                    </p>

                                    <!-- Hiển thị phần trăm sử dụng nếu vượt 70% -->
                                    <p th:if="${promo.getUsageCount() != null and promo.getUsageLimit() != null and (promo.getUsageCount() * 100.0 / promo.getUsageLimit()) > 70}"
                                       th:text="'Đã dùng ' + ${#numbers.formatDecimal(promo.getUsageCount() * 100.0 / promo.getUsageLimit(), 0, 1)} + '%'">
                                        Đã dùng ...
                                    </p>
                                    <!-- Nếu còn dưới 24 giờ -->
                                    <p class="text-xs text-white/70"
                                       th:if="${T(java.time.Duration).between(T(java.time.LocalDateTime).now(), promo.enddate).toHours() < 24}"
                                       th:text="'Hết hạn trong ' + ${T(java.time.Duration).between(T(java.time.LocalDateTime).now(), promo.enddate).toHours()} + 'h'">
                                        Hết hạn trong ...
                                    </p>

                                    <!-- Nếu trên 24 giờ -->
                                    <p class="text-xs text-white/70"
                                       th:unless="${T(java.time.Duration).between(T(java.time.LocalDateTime).now(), promo.enddate).toHours() < 24}"
                                       th:text="'Hết hạn lúc ' + ${#temporals.format(promo.enddate, 'dd/MM/yyyy HH:mm')}">
                                        Hết hạn lúc ...
                                    </p>




                                </div>

                                <input type="radio" name="discount" class="mt-2" th:value="${promo.getId()}"
                                       th:disabled="${price  < promo.getMinOrderValue()}"
                                />
                            </label>

                        </div>
                    </div>
                    <!-- Footer -->
                    <div class="flex justify-between mt-6">
                        <button id="cancelBtn" class="px-4 py-2 bg-white text-black rounded-md hover:bg-gray-200">Trở
                            lại
                        </button>
                        <button id="confirmBtn"
                                class="px-8 py-2 bg-gradient-to-r from-[#81C784] to-[#4DD0E1] hover:from-[#66BB6A] hover:to-[#26C6DA
                        text-white rounded-md shadow-md hover:opacity-90 transition duration-300">
                            OK
                        </button>

                    </div>
                </div>
            </div>
            Thời gian vận chuyển  <span id="timeDelivery"></span>

            <div class="table-container">
                <table id="buyNowItemsTable">
                    <thead>
                    <tr>
                        <th><i class="fas fa-image"></i> Hình ảnh</th>
                        <th><i class="fas fa-tag"></i> Tên sản phẩm</th>
                        <th><i class="fas fa-palette"></i> Màu</th>
                        <th><i class="fas fa-ruler"></i> Phân loại</th>
                        <th><i class="fas fa-dollar-sign"></i> Giá</th>
                        <th><i class="fas fa-sort-numeric-up"></i> Số lượng</th>
                        <th><i class="fas fa-cog"></i> Hành động</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="item : ${items}" th:if="${item.id == null}">
                        <td>
                            <img th:src="${item.imageUrl}" alt="Product Image" class="product-image"/>
                        </td>
                        <td>
                            <div class="product-name" th:text="${item.productName}"></div>
                        </td>
                        <td>
                            <span class="product-variant" th:text="${item.color ?: '-'}"></span>
                        </td>
                        <td>
                            <span class="product-variant" th:text="${item.dimension ?: '-'}"></span>
                        </td>
                        <td>
                        <span class="price"
                              th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + ' đ'"></span>
                           Phí ship <span id="feeShip"></span>
                            Trừ phí ship <span id="feeShipVoucher"></span>
                            khuyến mãi <span id="discountVoucher"></span>
                           Tổng  <span id="totalPrice"></span>
                        </td>
                        <td>
                            <span class="quantity" th:text="${item.quantity}"></span>
                        </td>
                        <td>
                            <form th:action="@{/checkout/realtime}" method="post" onsubmit="setTotalPrice(this)">
                                <input type="hidden" name="inventory" th:value="${item.inventoryId}"/>
                                <input type="hidden" name="quantity" th:value="${item.quantity}"/>
                                <input type="hidden" name="firstname" th:id="'buyNowFirstName_' + ${item.inventoryId}"/>
                                <input type="hidden" name="lastname" th:id="'buyNowLastName_' + ${item.inventoryId}"/>
                                <input type="hidden" name="phone" th:id="'buyNowPhone_' + ${item.inventoryId}"/>
                                <input type="hidden" name="address" th:id="'buyNowAddress_' + ${item.inventoryId}"/>

                                <input type="hidden" name="freeshipId" id="selectedFreeshipId"/>
                                <input type="hidden" name="discountId" id="selectedDiscountId"/>

                                <input type="hidden" name="totalPrice" id="inputTotalPrice"/>

                                <button type="submit" class="btn btn-link buyNowBtn">
                                    <i class="fas fa-lightning-bolt"></i>
                                    Thanh toán ngay
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Map Modal -->
<div id="mapModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:12px; padding:16px; max-width:90vw; max-height:90vh; position:relative;">
    <button id="closeMapBtn" style="position:absolute; top:8px; right:8px;">Đóng</button>
    <div id="map" style="width:70vw; height:60vh; min-width:300px; min-height:300px;"></div>
    </div>
</div>
<script>
let map, marker;
let defaultLocation = { lat: 10.8231, lng: 106.6297 }; // HCM City

document.getElementById('openMapBtn').onclick = function() {
    document.getElementById('mapModal').style.display = 'flex';
    setTimeout(initMap, 100); // Delay to ensure modal is visible
};

document.getElementById('closeMapBtn').onclick = function() {
    document.getElementById('mapModal').style.display = 'none';
};

function initMap() {
    // Load Leaflet CSS/JS if not loaded
    if (!window.L) {
        let css = document.createElement('link');
        css.rel = 'stylesheet';
        css.href = 'https://unpkg.com/leaflet/dist/leaflet.css';
        document.head.appendChild(css);

        let script = document.createElement('script');
        script.src = 'https://unpkg.com/leaflet/dist/leaflet.js';
        script.onload = createMap;
        document.body.appendChild(script);
    } else {
        createMap();
    }
}

function createMap() {
    if (map) {
        map.invalidateSize();
        return;
    }
    map = L.map('map').setView([defaultLocation.lat, defaultLocation.lng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    map.on('click', async function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        if (marker) {
            marker.setLatLng(e.latlng);
        } else {
            marker = L.marker(e.latlng).addTo(map);
        }
        // Reverse geocode
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1&accept-language=vi`);
            const data = await response.json();
            if (data && data.display_name) {
                document.getElementById('address').value = data.display_name;
            } else {
                document.getElementById('address').value = lat + ',' + lng;
            }
        } catch (err) {
            document.getElementById('address').value = lat + ',' + lng;
        }
        document.getElementById('mapModal').style.display = 'none';
    });
}

    function setTotalPrice(form) {
        const spanPrice = document.getElementById('totalPrice');
        const inputPrice = form.querySelector('input[name="totalPrice"]');

        if (spanPrice && inputPrice) {

            inputPrice.value = spanPrice.innerText.replace(/[^\d]/g, '');
        }
    }
    document.addEventListener("DOMContentLoaded", function () {
        // Gắn sự kiện cho radio freeship
        document.querySelectorAll('input[name="freeship"]').forEach(function (radio) {
            radio.addEventListener("change", function () {
                document.getElementById("selectedFreeshipId").value = this.value;
            });
        });

        // Gắn sự kiện cho radio discount
        document.querySelectorAll('input[name="discount"]').forEach(function (radio) {
            radio.addEventListener("change", function () {
                document.getElementById("selectedDiscountId").value = this.value;
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const firstNameInput = document.getElementById("firstname");
        const lastNameInput = document.getElementById("lastname");
        const phoneInput = document.getElementById("phone");
        const addressInput = document.getElementById("address");

        // Update cart form hidden inputs
        const cartSubmitBtn = document.getElementById("cartSubmitBtn");
        if (cartSubmitBtn) {
            cartSubmitBtn.addEventListener("click", function (e) {
                document.getElementById("cartFirstName").value = firstNameInput.value.trim();
                document.getElementById("cartLastName").value = lastNameInput.value.trim();
                document.getElementById("cartPhone").value = phoneInput.value.trim();
                document.getElementById("cartAddress").value = addressInput.value.trim();
            });
        }

        // Update buy now form hidden inputs
        document.querySelectorAll(".buyNowBtn").forEach(btn => {
            btn.addEventListener("click", function (e) {
                const form = btn.closest("form");
                const inventoryId = parseInt(form.querySelector("input[name='inventory']").value);
                if (!isNaN(inventoryId)) {
                    const firstNameField = document.querySelector(`#buyNowFirstName_${inventoryId}`);
                    const lastNameField = document.querySelector(`#buyNowLastName_${inventoryId}`);
                    const phoneField = document.querySelector(`#buyNowPhone_${inventoryId}`);
                    const addressField = document.querySelector(`#buyNowAddress_${inventoryId}`);

                    if (firstNameField && lastNameField && phoneField && addressField) {
                        firstNameField.value = firstNameInput.value.trim();
                        lastNameField.value = lastNameInput.value.trim();
                        phoneField.value = phoneInput.value.trim();
                        addressField.value = addressInput.value.trim();
                    } else {
                        console.error("Form fields not found for inventory ID: " + inventoryId);
                        e.preventDefault();
                        showNotification("Lỗi hệ thống khi gửi form. Vui lòng thử lại.", "error");
                    }
                } else {
                    console.error("Invalid inventory ID");
                    e.preventDefault();
                    showNotification("Lỗi không xác định được sản phẩm. Vui lòng thử lại.", "error");
                }
            });
        });
    });
</script>
</body>
</html>