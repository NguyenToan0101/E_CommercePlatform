<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Giỏ hàng</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-black: #0a0a0a;
      --secondary-black: #1a1a1a;
      --accent-gray: #2a2a2a;
      --light-gray: #f8f8f8;
      --border-gray: #e5e5e5;
      --text-gray: #666666;
      --white: #ffffff;
      --gold-accent: #d4af37;
      --success-green: #10b981;
      --error-red: #dc2626;
      --orange-accent: #ff6b35;
      --blue-accent: #3b82f6;
      --shopee-orange: #ee4d2d;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --shadow-medium: rgba(0, 0, 0, 0.1);
      --shadow-heavy: rgba(0, 0, 0, 0.15);

      /* Gradient colors from function.tsx */
      --gradient-start: #0a4d68;
      --gradient-mid: #088395;
      --gradient-end: #05bfdb;
      --gradient-light-end: #8de0a6;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-light-end) 100%);
      min-height: 100vh;
      color: var(--primary-black);
      line-height: 1.6;
    }

    .toast-container {
      position: fixed;
      top: 100px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: var(--white);
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 32px var(--shadow-medium);
      border-left: 4px solid var(--success-green);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      max-width: 400px;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.1s ease; /* Giảm thời gian animation */
    }

    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }

    .toast.success {
      border-left-color: var(--success-green);
    }

    .toast.error {
      border-left-color: var(--error-red);
    }

    .toast-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .toast-icon.success {
      color: var(--success-green);
    }

    .toast-icon.error {
      color: var(--error-red);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--primary-black);
      margin-bottom: 4px;
    }

    .toast-message {
      font-size: 13px;
      color: var(--text-gray);
      line-height: 1.4;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-gray);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.1s ease; /* Giảm thời gian transition */
    }

    .toast-close:hover {
      background: var(--light-gray);
      color: var(--primary-black);
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px); /* Giảm blur để tăng tốc */
      border-bottom: 1px solid var(--border-gray);
      z-index: 1000;
      padding: 16px 0;
      transition: all 0.1s ease; /* Giảm thời gian transition */
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 40px;
      display: grid;
      grid-template-columns: 200px 1fr auto 200px;
      gap: 20px;
      align-items: center;
    }

    .logo-container {
      display: inline-block;
      transition: all 0.1s ease; /* Giảm thời gian transition */
      justify-self: start;
    }

    .logo-placeholder {
      width: 120px;
      height: 40px;
      background: var(--light-gray);
      border: 2px dashed var(--border-gray);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-gray);
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .search-container {
      position: relative;
      max-width: 600px;
      width: 100%;
      justify-self: center;
    }

    .search-form {
      position: relative;
      display: flex;
      align-items: center;
      background: var(--white);
      border: 2px solid var(--border-gray);
      border-radius: 50px;
      overflow: hidden;
      box-shadow: 0 2px 8px var(--shadow-light); /* Giảm độ phức tạp shadow */
      transition: all 0.1s ease; /* Giảm thời gian transition */
    }

    .search-input {
      flex: 1;
      border: none;
      outline: none;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      color: var(--primary-black);
      background: transparent;
      font-family: inherit;
    }

    .search-button {
      background: linear-gradient(135deg, var(--gradient-mid), var(--gradient-end));
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.1s ease; /* Giảm thời gian transition */
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 50px;
    }

    .cart-container {
      position: relative;
      justify-self: center;
    }

    .cart-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      background: var(--white);
      border: 2px solid var(--border-gray);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.1s ease; /* Giảm thời gian transition */
      box-shadow: 0 2px 8px var(--shadow-light); /* Giảm độ phức tạp shadow */
      text-decoration: none;
      color: var(--gradient-mid);
    }

    .cart-icon:hover {
      background: var(--gradient-mid);
      color: var(--white);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-medium);
      border-color: var(--gradient-mid);
    }

    .cart-icon svg {
      width: 20px;
      height: 20px;
      transition: all 0.1s ease; /* Giảm thời gian transition */
    }

    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--shopee-orange);
      color: var(--white);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      border: 2px solid var(--white);
    }

    .customer-info {
      position: relative;
      justify-self: end;
    }

    .dropdown {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      background: var(--white);
      padding: 8px 16px;
      border-radius: 50px;
      box-shadow: 0 2px 8px var(--shadow-light); /* Giảm độ phức tạp shadow */
      border: 1px solid var(--border-gray);
      transition: all 0.1s ease; /* Giảm thời gian transition */
      position: relative;
    }

    .dropdown:hover {
      box-shadow: 0 4px 12px var(--shadow-medium);
      transform: translateY(-1px);
      border-color: var(--accent-gray);
    }

    .customer-name {
      font-weight: 500;
      color: var(--primary-black);
      font-size: 14px;
      white-space: nowrap;
      letter-spacing: 0.3px;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid var(--border-gray);
      object-fit: cover;
      transition: all 0.1s ease; /* Giảm thời gian transition */
      background: var(--light-gray);
    }

    .dropdown:hover .avatar {
      transform: scale(1.05);
      border-color: var(--primary-black);
    }

    .dropdown-arrow {
      width: 16px;
      height: 16px;
      color: var(--text-gray);
      transition: all 0.1s ease; /* Giảm thời gian transition */
    }

    .dropdown:hover .dropdown-arrow {
      color: var(--primary-black);
      transform: rotate(180deg);
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--white);
      min-width: 200px;
      border-radius: 16px;
      box-shadow: 0 8px 24px var(--shadow-medium); /* Giảm độ phức tạp shadow */
      border: 1px solid var(--border-gray);
      overflow: hidden;
      animation: slideDown 0.1s ease; /* Giảm thời gian animation */
      z-index: 1001;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .dropdown-content::before {
      content: '';
      position: absolute;
      top: -6px;
      right: 20px;
      width: 12px;
      height: 12px;
      background: var(--white);
      border: 1px solid var(--border-gray);
      border-bottom: none;
      border-right: none;
      transform: rotate(45deg);
    }

    .dropdown-content a {
      color: var(--primary-black);
      padding: 16px 20px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.1s ease; /* Giảm thời gian transition */
      border-left: 3px solid transparent;
    }

    .dropdown-content a:hover {
      background: var(--light-gray);
      border-left-color: var(--primary-black);
      color: var(--primary-black);
      transform: translateX(4px);
    }

    .dropdown-content a:not(:last-child) {
      border-bottom: 1px solid var(--border-gray);
    }

    .dropdown-content a .icon {
      width: 16px;
      height: 16px;
      color: var(--text-gray);
      transition: color 0.1s ease; /* Giảm thời gian transition */
    }

    .dropdown-content a:hover .icon {
      color: var(--primary-black);
    }

    .dropdown:hover .dropdown-content,
    .dropdown-content:hover {
      display: block;
      opacity: 1;
      visibility: visible;
    }

    .login-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--gradient-mid);
      color: var(--white);
      padding: 10px 20px;
      border-radius: 50px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.1s ease; /* Giảm thời gian transition */
      border: 2px solid var(--gradient-mid);
      justify-self: end;
    }

    .login-btn:hover {
      background: var(--white);
      color: var(--gradient-mid);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--shadow-medium);
    }

    .login-btn svg {
      width: 16px;
      height: 16px;
    }

    .main-content {
      padding: 120px 40px 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .cart-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 20px;
      align-items: start;
    }

    .cart-main {
      background: var(--white);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px var(--shadow-light); /* Giảm độ phức tạp shadow */
    }

    .cart-header {
      background: var(--white);
      padding: 20px;
      border-bottom: 1px solid var(--border-gray);
      display: contents;
      align-items: center;
      gap: 15px;
    }

    .select-all-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--shopee-orange);
      cursor: pointer;
    }

    .cart-header-text {
      font-size: 16px;
      font-weight: 500;
      color: var(--primary-black);
    }

    .cart-header-labels {
      display: grid;
      grid-template-columns: 40px 2fr 1fr 1fr 1fr 80px;
      gap: 60px;
      align-items: center;
      margin-left: auto;
      font-size: 14px;
      color: var(--text-gray);
      font-weight: 500;
    }

    .cart-items {
      background: var(--white);
    }

    .cart-item {
      padding: 20px;
      border-bottom: 1px solid var(--border-gray);
      display: grid;
      grid-template-columns: 40px 2fr 1fr 1fr 1fr 80px;
      gap: 20px;
      align-items: center;
      transition: all 0.1s ease; /* Giảm thời gian transition */
    }

    .cart-item:hover {
      background: var(--light-gray);
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item.removing {
      opacity: 0.5;
      transform: scale(0.98);
      pointer-events: none;
      transition: all 0.1s ease; /* Giảm thời gian transition */
    }

    .item-checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--shopee-orange);
      cursor: pointer;
      grid-column: 1 / 2;
    }

    .item-info {
      grid-column: 2 / 3;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .product-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border-gray);
    }

    .product-details {
      flex: 1;
    }

    .product-name {
      font-size: 16px;
      font-weight: 500;
      color: var(--primary-black);
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .product-name-link {
      text-decoration: none;
      color: var(--primary-black);
      transition: color 0.1s ease; /* Giảm thời gian transition */
      display: block;
    }

    .product-name-link:hover {
      color: var(--shopee-orange);
      text-decoration: underline;
    }

    .product-variants {
      grid-column: 3 / 4;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .variant-tag {
      background: var(--light-gray);
      color: var(--text-gray);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .quantity-controls {
      grid-column: 4 / 5;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border-gray);
      border-radius: 4px;
      background: var(--white);
      width: fit-content;
      margin: 0;
    }

    .quantity-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: var(--text-gray);
      transition: all 0.1s ease; /* Giảm thời gian transition */
    }

    .quantity-btn:hover {
      background: var(--light-gray);
      color: var(--primary-black);
    }

    .quantity-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .quantity-input {
      width: 50px;
      height: 32px;
      border: none;
      text-align: center;
      font-size: 14px;
      background: transparent;
    }

    .item-total {
      grid-column: 5 / 6;
      font-size: 16px;
      font-weight: 600;
      color: var(--shopee-orange);
      text-align: center;
    }

    .item-actions {
      grid-column: 6 / 7;
      display: flex;
      justify-content: center;
    }

    .btn-remove {
      background: none;
      border: none;
      color: var(--text-gray);
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.1s ease; /* Giảm thời gian transition */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-remove:hover {
      background: var(--error-red);
      color: var(--white);
    }

    .btn-remove:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .continue-shopping-section {
      background: var(--white);
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      text-align: center;
      box-shadow: 0 2px 8px var(--shadow-light); /* Giảm độ phức tạp shadow */
    }

    .continue-shopping {
      background: var(--shopee-orange);
      color: var(--white);
      padding: 12px 30px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.1s ease; /* Giảm thời gian transition */
      display: inline-block;
    }

    .continue-shopping:hover {
      background: #d73211;
      transform: translateY(-1px);
    }

    .cart-summary {
      background: var(--white);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px var(--shadow-light); /* Giảm độ phức tạp shadow */
      position: sticky;
      top: 140px;
      display: none;
    }

    .cart-summary.show {
      display: block;
    }

    .summary-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-black);
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-gray);
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .summary-label {
      color: var(--text-gray);
    }

    .summary-value {
      font-weight: 500;
      color: var(--primary-black);
    }

    .summary-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-gray);
      font-size: 18px;
      font-weight: 600;
    }

    .total-label {
      color: var(--primary-black);
    }

    .total-value {
      color: var(--shopee-orange);
      font-size: 20px;
    }

    .checkout-btn {
      width: 100%;
      background: var(--shopee-orange);
      color: var(--white);
      padding: 15px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 20px;
      cursor: pointer;
      transition: all 0.1s ease; /* Giảm thời gian transition */
    }

    .checkout-btn:hover {
      background: #d73211;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(238, 77, 45, 0.3); /* Giảm độ phức tạp shadow */
    }

    .checkout-btn:disabled {
      background: var(--border-gray);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .empty-cart {
      text-align: center;
      padding: 80px 40px;
      background: var(--white);
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--shadow-light); /* Giảm độ phức tạp shadow */
    }

    .empty-cart h3 {
      font-size: 24px;
      font-weight: 600;
      color: var(--primary-black);
      margin-bottom: 15px;
    }

    .empty-cart p {
      font-size: 16px;
      color: var(--text-gray);
      margin-bottom: 30px;
    }

    .flash-message {
      margin-bottom: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      font-weight: 500;
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success-green);
      color: var(--success-green);
    }

    .alert-error {
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid var(--error-red);
      color: var(--error-red);
    }

    @media (max-width: 1024px) {
      .cart-layout {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .cart-summary {
        position: static;
      }

      .toast-container {
        right: 10px;
        left: 10px;
      }

      .toast {
        min-width: auto;
      }
    }

    @media (max-width: 768px) {
      .header-content {
        grid-template-columns: 1fr;
        gap: 15px;
        padding: 0 20px;
      }

      .main-content {
        padding: 140px 20px 20px;
      }

      .cart-header-labels {
        display: none;
      }

      .cart-item {
        grid-template-columns: 40px 1fr;
        gap: 15px;
        padding: 15px;
      }

      .item-info {
        grid-column: 1 / -1;
        margin-top: 10px;
      }

      .product-variants {
        grid-column: 1 / -1;
        margin-top: 10px;
      }

      .quantity-controls {
        grid-column: 1 / -1;
        margin-top: 10px;
        text-align: left;
        justify-content: flex-start;
      }

      .item-total {
        grid-column: 1 / -1;
        margin-top: 10px;
        text-align: left;
      }

      .item-actions {
        grid-column: 1 / -1;
        margin-top: 10px;
        justify-content: flex-start;
      }

      .toast-container {
        top: 80px;
      }
    }
  </style>
</head>
<body>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<!-- Header matching product-detail.html style -->
<header class="header">
  <div class="header-content">
    <a href="/home" class="logo-container">
      <div class="logo-placeholder">
        <span>Your Logo</span>
      </div>
    </a>

    <div class="search-container">
      <form class="search-form" action="/search_name" method="GET">
        <input type="text" name="keyword" class="search-input" placeholder="Tìm kiếm sản phẩm...">
        <button type="submit" class="search-button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="11" cy="11" r="8" stroke="white" stroke-width="2"/>
            <path d="m21 21-4.35-4.35" stroke="white" stroke-width="2"/>
          </svg>
        </button>
      </form>
    </div>

    <!-- Shopping Cart Icon -->
    <div class="cart-container">
      <a th:href="@{/cart}" class="cart-icon" title="Giỏ hàng">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 3H5L5.4 5M7 13H17L21 5H5.4M7 13L5.4 5M7 13L4.7 15.3C4.3 15.7 4.6 16.5 5.1 16.5H17M17 13V16.5M9 19.5C9.8 19.5 10.5 20.2 10.5 21S9.8 22.5 9 22.5 7.5 21.8 7.5 21 8.2 19.5 9 19.5ZM20 19.5C20.8 19.5 21.5 20.2 21.5 21S20.8 22.5 20 22.5 18.5 21.8 18.5 21 19.2 19.5 20 19.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="cart-badge" th:text="${#lists.size(cartItems)}">0</span>
      </a>
    </div>

    <!-- Customer Info or Login Button -->
    <div class="customer-info" th:if="${customer}">
      <div class="dropdown" id="customerDropdown" tabindex="0">
        <span class="customer-name" th:text="${customer.firstname + ' ' + customer.lastname}"></span>
        <img th:if="${customer.image != null and customer.image != ''}"
             th:src="@{${customer.image}}"
             alt="Avatar" class="avatar" />

        <svg class="dropdown-arrow" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>

        <div class="dropdown-content" id="dropdownContent">
          <a th:href="@{/customers/profile}">
            <svg class="icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 8C10.2091 8 12 6.20914 12 4C12 1.79086 10.2091 0 8 0C5.79086 0 4 1.79086 4 4C4 6.20914 5.79086 8 8 8Z" fill="currentColor"/>
              <path d="M8 10C3.58172 10 0 13.5817 0 18H16C16 13.5817 12.4183 10 8 10Z" fill="currentColor"/>
            </svg>
            Xem profile
          </a>
          <a th:href="@{/customers/change-password}">
            <svg class="icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 7V5C4 2.79086 5.79086 1 8 1C10.2091 1 12 2.79086 12 5V7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <rect x="2" y="7" width="12" height="8" rx="2" stroke="currentColor" stroke-width="2"/>
              <circle cx="8" cy="11" r="1" fill="currentColor"/>
            </svg>
            Đổi mật khẩu
          </a>
          <a th:href="@{/logout}">
            <svg class="icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 2H3C2.44772 2 2 2.44772 2 3V13C2 13.5523 2.44772 14 3 14H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M10 6L14 10L10 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M14 10H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Đăng xuất
          </a>
        </div>
      </div>
    </div>

    <!-- Login Button (shown when customer is null) -->
    <div th:unless="${customer}">
      <a href="/login" class="login-btn">
        <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 2H3C2.44772 2 2 2.44772 2 3V13C2 13.5523 2.44772 14 3 14H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M10 6L14 10L10 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 10H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Đăng nhập
      </a>
    </div>
  </div>
</header>

<main class="main-content">
  <!-- Flash message display -->
  <div th:if="${message}" class="flash-message alert-success" th:text="${message}"></div>
  <div th:if="${error}" class="flash-message alert-error" th:text="${error}"></div>

  <!-- Empty cart message -->
  <div th:if="${#lists.isEmpty(cartItems)}" class="empty-cart">
    <h3>Giỏ hàng của bạn đang trống</h3>
    <p>Hãy thêm sản phẩm vào giỏ hàng để tiếp tục mua sắm</p>
    <a href="javascript:history.back()" class="continue-shopping">Tiếp tục mua sắm</a>
  </div>

  <!-- Cart Layout (Shopee style) -->
  <div th:if="${not #lists.isEmpty(cartItems)}" class="cart-layout">
    <!-- Main Cart Area -->
    <div class="cart-main">
      <!-- Cart Header with Select All -->
      <div class="cart-header">
        <div class="select-all-container">
          <input type="checkbox" id="select-all" class="checkbox" onchange="toggleSelectAll()">
          <label for="select-all" class="cart-header-text">Chọn tất cả</label>
        </div>

        <div class="cart-header-labels">
          <span></span>
          <span>Sản phẩm</span>
          <span>Biến thể</span>
          <span>Số lượng</span>
          <span>Thành tiền</span>
          <span>Thao tác</span>
        </div>
      </div>

      <!-- Cart Items -->
      <div class="cart-items">
        <div class="cart-item" th:each="item : ${cartItems}" th:data-cart-item-id="${item.cartItemId}">
          <!-- Checkbox -->
          <input type="checkbox" class="item-checkbox" th:data-item-id="${item.cartItemId}"
                 th:data-price="${item.price}" th:data-quantity="${item.quantity}" onchange="updateSummary()">

          <!-- Product Info -->
          <div class="item-info">
            <a th:href="@{/detailproduct(id=${item.productId})}" title="Xem chi tiết sản phẩm">
              <img th:src="${item.imageUrl != null ? item.imageUrl : '/images/default-product.jpg'}"
                   alt="Product Image" class="product-image">
            </a>
            <div class="product-details">
              <a th:href="@{/detailproduct(id=${item.productId})}" class="product-name-link">
                <div class="product-name" th:text="${item.productName}">Product Name</div>
              </a>
            </div>
          </div>

          <!-- Variants -->
          <div class="product-variants">
            <span class="variant-tag" th:if="${item.color}" th:text="'Màu: ' + ${item.color}">Màu: Đỏ</span>
            <span class="variant-tag" th:if="${item.dimension}" th:text="'Size: ' + ${item.dimension}">Size: M</span>
          </div>

          <!-- Quantity Controls -->
          <div class="quantity-controls">
            <input type="hidden" class="cart-item-id" th:value="${item.cartItemId}">
            <input type="hidden" class="product-id" th:value="${item.productId}">
            <input type="hidden" class="inventory-id" th:value="${item.inventoryId}">
            <button type="button" class="quantity-btn" onclick="decreaseQuantity(this)">-</button>
            <input type="number" th:value="${item.quantity}" min="1" class="quantity-input"
                   onchange="updateQuantityDebounced(this)" th:data-original-quantity="${item.quantity}">
            <button type="button" class="quantity-btn" onclick="increaseQuantity(this)">+</button>
          </div>

          <!-- Item Total -->
          <div class="item-total" th:text="${#numbers.formatDecimal(item.price * item.quantity, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Subtotal</div>

          <!-- Actions -->
          <div class="item-actions">
            <button type="button" class="btn-remove" th:data-cart-item-id="${item.cartItemId}"
                    th:data-product-name="${item.productName}" onclick="removeCartItem(this)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Cart Summary (Sticky) -->
    <div class="cart-summary" id="cart-summary">
      <div class="summary-title">Tóm tắt đơn hàng</div>

      <div class="summary-row">
        <span class="summary-label">Tổng số sản phẩm:</span>
        <span class="summary-value" id="selected-count">0 sản phẩm</span>
      </div>

      <div class="summary-row">
        <span class="summary-label">Tạm tính:</span>
        <span class="summary-value" id="subtotal">0 ₫</span>
      </div>

      <div class="summary-row">
        <span class="summary-label">Phí vận chuyển:</span>
        <span class="summary-value">Miễn phí</span>
      </div>

      <div class="summary-total">
        <span class="total-label">Tổng tiền:</span>
        <span class="total-value" id="total">0 ₫</span>
      </div>

      <!-- Updated Checkout Form -->
      <form id="checkout-form" action="/checkout/preview" method="GET">
        <!-- Hidden inputs for selected cart item IDs will be added here by JavaScript -->
        <button type="submit" class="checkout-btn" id="checkout-btn" disabled>
          Mua hàng (<span id="checkout-count">0</span>)
        </button>
      </form>
    </div>
  </div>

  <!-- Continue Shopping Section - Moved outside cart layout -->
  <div th:if="${not #lists.isEmpty(cartItems)}" class="continue-shopping-section">
    <a href="javascript:history.back()" class="continue-shopping">Tiếp tục mua sắm</a>
  </div>
</main>

<script>
  // Toast notification system - Only for delete operations
  function showToast(type, title, message) {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const iconSvg = {
      success: '<svg class="toast-icon success" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>',
      error: '<svg class="toast-icon error" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>'
    };

    toast.innerHTML = `
      ${iconSvg[type]}
      <div class="toast-content">
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
      </div>
      <button class="toast-close" onclick="closeToast(this)">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10.5 3.5L3.5 10.5M3.5 3.5L10.5 10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    `;

    toastContainer.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 50); // Giảm thời gian delay

    setTimeout(() => closeToast(toast.querySelector('.toast-close')), 3000); // Giảm thời gian hiển thị toast
  }

  function closeToast(button) {
    const toast = button.closest('.toast');
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 100); // Giảm thời gian remove
  }

  let quantityUpdateTimeout;
  function updateQuantityDebounced(input) {
    clearTimeout(quantityUpdateTimeout);
    quantityUpdateTimeout = setTimeout(() => {
      updateCartQuantity(input);
    }, 300); // Giảm thời gian debounce xuống 300ms
  }

  async function updateCartQuantity(input) {
    const cartItem = input.closest('.cart-item');
    const cartItemId = cartItem.querySelector('.cart-item-id').value;
    const productId = cartItem.querySelector('.product-id').value;
    const inventoryId = cartItem.querySelector('.inventory-id').value;
    const quantity = parseInt(input.value);
    const originalQuantity = parseInt(input.dataset.originalQuantity);

    if (quantity < 1) {
      input.value = 1;
      return;
    }

    if (quantity === originalQuantity) {
      return;
    }

    try {
      input.disabled = true;

      const formData = new FormData();
      formData.append('cartItemId', cartItemId);
      formData.append('productId', productId);
      formData.append('inventoryId', inventoryId);
      formData.append('quantity', quantity);

      const response = await fetch('/cart/update', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        // Reload nhanh với forced refresh
        location.reload(true);
      } else {
        input.value = originalQuantity;
      }
    } catch (error) {
      input.value = originalQuantity;
    } finally {
      input.disabled = false;
    }
  }

  async function removeCartItem(button) {
    const cartItemId = button.dataset.cartItemId;
    const productName = button.dataset.productName;
    const cartItem = button.closest('.cart-item');

    try {
      cartItem.classList.add('removing');
      button.disabled = true;

      const formData = new FormData();
      formData.append('cartItemId', cartItemId);

      const response = await fetch('/cart/remove', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        cartItem.style.transform = 'translateX(-100%)';
        cartItem.style.opacity = '0';
        cartItem.style.transition = 'all 0.1s ease'; // Giảm thời gian transition

        setTimeout(() => {
          cartItem.remove();
          updateCartBadge();
          updateSummary();
          const remainingItems = document.querySelectorAll('.cart-item');
          if (remainingItems.length === 0) {
            location.reload(true);
          }
        }, 100); // Giảm thời gian delay

        showToast('success', 'Xóa thành công', `"${productName}" đã được xóa khỏi giỏ hàng`);
      } else {
        cartItem.classList.remove('removing');
        button.disabled = false;
        showToast('error', 'Xóa thất bại', 'Không thể xóa sản phẩm khỏi giỏ hàng');
      }
    } catch (error) {
      cartItem.classList.remove('removing');
      button.disabled = false;
      showToast('error', 'Lỗi kết nối', 'Vui lòng thử lại sau');
    }
  }

  function increaseQuantity(button) {
    const input = button.parentElement.querySelector('.quantity-input');
    input.value = parseInt(input.value) + 1;
    updateQuantityDebounced(input);
  }

  function decreaseQuantity(button) {
    const input = button.parentElement.querySelector('.quantity-input');
    if (parseInt(input.value) > 1) {
      input.value = parseInt(input.value) - 1;
      updateQuantityDebounced(input);
    }
  }

  function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all');
    const itemCheckboxes = document.querySelectorAll('.item-checkbox');

    itemCheckboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });

    updateSummary();
  }

  function updateSummary() {
    const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
    const summary = document.getElementById('cart-summary');
    const selectAllCheckbox = document.getElementById('select-all');
    const allCheckboxes = document.querySelectorAll('.item-checkbox');

    selectAllCheckbox.checked = selectedCheckboxes.length === allCheckboxes.length && allCheckboxes.length > 0;
    selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < allCheckboxes.length;

    if (selectedCheckboxes.length === 0) {
      summary.classList.remove('show');
      return;
    }

    summary.classList.add('show');

    let totalQuantity = 0;
    let totalPrice = 0;

    selectedCheckboxes.forEach(checkbox => {
      const price = parseFloat(checkbox.dataset.price);
      const quantity = parseInt(checkbox.dataset.quantity);
      totalQuantity += quantity;
      totalPrice += price * quantity;
    });

    document.getElementById('selected-count').textContent = totalQuantity + ' sản phẩm';
    document.getElementById('subtotal').textContent = formatPrice(totalPrice) + ' ₫';
    document.getElementById('total').textContent = formatPrice(totalPrice) + ' ₫';
    document.getElementById('checkout-count').textContent = selectedCheckboxes.length;

    const checkoutBtn = document.getElementById('checkout-btn');
    checkoutBtn.disabled = selectedCheckboxes.length === 0;

    updateCheckoutForm();
  }

  function updateCheckoutForm() {
    const checkoutForm = document.getElementById('checkout-form');
    const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');

    const existingInputs = checkoutForm.querySelectorAll('input[name="cartItemIds"]');
    existingInputs.forEach(input => input.remove());

    selectedCheckboxes.forEach(checkbox => {
      const cartItemId = checkbox.dataset.itemId;
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'cartItemIds';
      hiddenInput.value = cartItemId;
      checkoutForm.appendChild(hiddenInput);
    });
  }

  function updateCartBadge() {
    const cartItems = document.querySelectorAll('.cart-item');
    const badge = document.querySelector('.cart-badge');
    if (badge) {
      badge.textContent = cartItems.length;
    }
  }

  function formatPrice(price) {
    return new Intl.NumberFormat('vi-VN').format(price);
  }

  const dropdown = document.getElementById('customerDropdown');
  const dropdownContent = document.getElementById('dropdownContent');

  if (dropdown && dropdownContent) {
    let hideTimeout;
    let isDropdownOpen = false;

    function showDropdown() {
      clearTimeout(hideTimeout);
      dropdownContent.style.display = 'block';
      isDropdownOpen = true;
      dropdown.setAttribute('aria-expanded', 'true');
      dropdownContent.setAttribute('aria-hidden', 'false');
    }

    function hideDropdown() {
      hideTimeout = setTimeout(function() {
        dropdownContent.style.display = 'none';
        isDropdownOpen = false;
        dropdown.setAttribute('aria-expanded', 'false');
        dropdownContent.setAttribute('aria-hidden', 'true');
      }, 100); // Giảm thời gian delay
    }

    dropdown.addEventListener('mouseenter', showDropdown);
    dropdown.addEventListener('mouseleave', hideDropdown);
    dropdownContent.addEventListener('mouseenter', function() {
      clearTimeout(hideTimeout);
    });
    dropdownContent.addEventListener('mouseleave', hideDropdown);

    dropdown.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (isDropdownOpen) {
          hideDropdown();
        } else {
          showDropdown();
        }
      }
    });

    document.addEventListener('click', function(e) {
      if (!dropdown.contains(e.target) && !dropdownContent.contains(e.target)) {
        hideDropdown();
      }
    });

    dropdown.setAttribute('aria-expanded', 'false');
    dropdown.setAttribute('aria-haspopup', 'true');
    dropdownContent.setAttribute('aria-hidden', 'true');
  }

  document.addEventListener('DOMContentLoaded', function() {
    updateSummary();
  });
</script>

</body>
</html>